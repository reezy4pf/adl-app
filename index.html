<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADL Checklist</title>
    <!-- SUPABASE SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles_progress.css?v=3">
    <link rel="stylesheet" href="src/ui/modals/sleep.css">
    <style>
        :root {
            --primary: #284393;
            --primary-dark: #1e3372;
            --primary-light: #EEF2FF;
            --secondary: #39d2c0;
            --text-dark: #1D1D1D;
            --text-dark: #1D1D1D;
            --text-light: #6B7280;
            --text-secondary: #6B7280;
            --success: #10B981;
            --bg-body: #ffffff;
            /* Requested #ffffff */
            --bg-card: #EEEEEE;
            /* Requested #EEEEEE */
            --bg-hover: #DFDFDF;
            /* Requested #DFDFDF */
            --modal-overlay: rgba(0, 0, 0, 0.4);
            --border-light: #E5E7EB;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-dark);
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
            /* Prevent body scroll, use content scroll */
        }

        /* Narrow Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
            /* Narrow */
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }

        /* --- LAYOUT --- */
        .sidebar {
            width: 240px;
            /* Widened from 80px */
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 16px;
            /* Added horizontal padding */
            border-right: 1px solid #E5E7EB;
            z-index: 20;
        }

        .nav-menu {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Nav Items - Glassy Tech Look */
        .nav-item {
            display: flex;
            /* Changed from Column to Row likely needed for label */
            align-items: center;
            justify-content: flex-start;
            /* Align left */
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            color: var(--text-light);
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);

            /* Glassy Visibility Fix: Light Grey Tint + Border */
            background: rgba(243, 244, 246, 0.6);
            /* Visible 'glass' on white */
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0, 0, 0, 0.04);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);

            width: 100%;
            font-weight: 500;
            cursor: pointer;
            /* Interaction Fix */
        }

        .nav-item:hover {
            background: rgba(40, 67, 147, 0.08);
            /* Primary tint */
            transform: translateX(4px);
            color: var(--primary);
            border-color: rgba(40, 67, 147, 0.1);
            box-shadow: 0 4px 12px rgba(40, 67, 147, 0.08);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 67, 147, 0.3);
            /* Tech Glow */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* SVG Icon styling */
        .nav-icon {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
        }

        /* Label styling */
        .nav-label {
            font-size: 0.95rem;
            font-weight: 500;
        }

        /* Ensure Logo Area matches width */
        .sidebar-logo {
            margin-bottom: 40px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            width: 100%;
            text-align: center;
        }

        .main-content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            width: 100%;
            /* Ensure full width */
            position: relative;
        }

        .view-section {
            max-width: 800px;
            margin: 0 auto;
            padding: 0;
            width: 100%;
        }

        /* --- CARDS --- */
        /* --- CARDS --- */
        /* .progress-card styles moved to styles_progress.css */

        /* --- TASKS --- */
        #task-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 0;
        }

        .task-list {
            list-style: none;
            padding: 0;
            margin: 0;
            background: transparent;
            /* Was var(--bg-card) */
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .task-item {
            display: flex;
            align-items: flex-start;
            /* Align top for multiline notes */
            padding: 16px 16px 16px 24px;
            background: var(--bg-card);
            transition: background 0.2s;
            position: relative;
            border-radius: 25px;
            /* For actions */
            gap: 12px;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-item:hover {
            background-color: var(--bg-hover);
            /* Requested Hover */
        }

        .add-task-row {
            padding: 10px 20px;
            background: transparent;
            text-align: center;
            margin-top: -10px;
            /* Pull up to join list visually? Or separate? */
            /* If tasks are in a card, add button should be part of it or below? */
            /* Let's put add button inside the card flow. */
        }

        .add-btn {
            background: transparent;
            color: var(--text-light);
            border: 2px dashed #D1D5DB;
            border-radius: 12px;
            padding: 12px;
            width: 100%;
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            font-size: 0.95rem;
            /* Reduced font size from previous polish */
        }

        .add-btn:hover {
            background: rgba(0, 0, 0, 0.03);
            color: var(--primary);
            border-color: var(--primary);
        }

        /* --- LIFECYCLE BUTTONS --- */
        .lifecycle-btn {
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            margin-right: 8px;
            /* Space from menu */
            white-space: nowrap;
        }

        .btn-start-task {
            background-color: #39d2c0;
            /* Requested Color */
            color: white;
            box-shadow: 0 2px 5px rgba(57, 210, 192, 0.2);
        }

        .btn-end-task {
            background: linear-gradient(135deg, #FF9966, #FF5E62);
            color: white;
        }

        /* --- MODAL --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* Time picker modal needs higher z-index to appear above task modal */
        #time-picker-modal {
            z-index: 2000;
        }

        .modal-overlay.show {
            opacity: 1;
        }

        /* Modal Scrolling */
        .modal-card {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: 25px;
            padding: 32px;
            text-align: center;
            /* Scroll fix */
            max-height: 85vh;
            overflow-y: auto;

            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            /* Reset transform for safe animation interaction with scroll */
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Circular Day Selectors */
        .days-grid {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 15px;
            /* Added spacing */
        }

        .day-label {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #E5E7EB;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-light);
            cursor: pointer;
            transition: 0.2s;
            background: white;
        }

        .day-cb {
            display: none;
        }

        .day-cb:checked+.day-label {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
        }

        /* Reminder Padding & Shape */
        #tm-remind-val {
            padding: 12px 14px;
            width: 90px;
            /* Increased from ~60px default/placeholder */
            border-radius: 8px;
            /* Match others */
            border: 1px solid #ddd;
        }

        #tm-remind-unit {
            padding: 12px 14px;
            border-radius: 8px;
            /* Match others */
            border: 1px solid #ddd;
        }

        /* Spacing for Dividers */
        .toggle-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 0;
            /* More balanced top/bottom padding */
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            width: 100%;
            margin-bottom: 20px;
            /* Space AFTER the divider */
        }

        .section-divider {
            /* Optional helper if needed */
            margin-bottom: 20px;
        }

        /* Menu Fix Z-Index */
        .action-menu {
            position: absolute;
            /* Changed from fixed to absolute relative to body */
            z-index: 9999;
            /* Higher z-index */
            /* ... rest same */
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 12px;
            width: 140px;
            display: none;
            list-style: none;
            overflow: hidden;
        }

        .modal-overlay.show .modal-card {
            transform: scale(1);
        }

        .modal-title {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 16px;
            font-weight: 700;
        }

        .modal-stats {
            margin: 24px 0;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .m-stat-item {
            display: flex;
            flex-direction: column;
        }

        .m-stat-val {
            font-size: 2rem;
            font-weight: 700;
            color: var(--secondary);
        }

        .m-stat-label {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .modal-streak-msg {
            background-color: #fff9e6;
            color: #d97706;
            padding: 12px;
            border-radius: 12px;
            font-weight: 600;
            margin-bottom: 24px;
            display: none;
        }

        .modal-buttons {
            display: flex;
            gap: 32px;
            /* Increased from 12px */
            justify-content: center;
        }

        .btn-modal-primary {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(40, 67, 147, 0.3);
            transition: transform 0.2s;
        }

        .btn-modal-primary:hover {
            transform: translateY(-2px);
        }

        .btn-modal-secondary {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            font-weight: 500;
        }

        /* --- Task Detail Modal --- */
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            color: #1D1D1D;
            /* Updated per request */
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: var(--font-family);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Time Picker Styles */
        .time-picker-container {
            display: flex;
            align-items: center;
            gap: 4px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 4px 6px;
            height: 60px;
            width: 100%;
            position: relative;
        }

        .time-picker-container::before {
            content: '';
            position: absolute;
            left: 6px;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            height: 30px;
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid var(--primary);
            border-radius: 6px;
            pointer-events: none;
            z-index: 1;
        }

        .time-picker-scroll {
            flex: 1;
            height: 100%;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            text-align: center;
            -webkit-overflow-scrolling: touch;
            position: relative;
            z-index: 2;
        }

        .time-picker-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .time-picker-scroll::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 2px;
        }

        .time-option {
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.95rem;
            font-weight: 500;
            scroll-snap-align: center;
            transition: all 0.2s;
            color: #999;
        }

        .time-option.selected {
            color: var(--text-dark);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .time-separator {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-dark);
            padding: 0 2px;
        }

        /* Time Picker Button */
        .time-picker-btn {
            width: 100%;
            padding: 12px 16px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .time-picker-btn:hover {
            background: #f0f0f0;
            border-color: var(--primary);
        }

        /* Popup Modal Styles */
        .time-picker-popup-card {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 320px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .time-picker-popup-header {
            padding: 16px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-dark);
            border-bottom: 1px solid #eee;
        }

        .time-picker-popup-body {
            padding: 20px;
            background: #f5f5f5;
        }

        .time-picker-container-popup {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f5f5f5;
            border-radius: 12px;
            padding: 8px;
            height: 180px;
            position: relative;
        }

        /* Center selection indicator for popup */
        .time-picker-container-popup::before {
            content: '';
            position: absolute;
            left: 8px;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            height: 44px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            pointer-events: none;
            z-index: 1;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .time-picker-scroll-popup {
            flex: 1;
            height: 100%;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            text-align: center;
            position: relative;
            z-index: 2;
            -webkit-mask-image: linear-gradient(to bottom,
                    transparent 0%,
                    black 25%,
                    black 75%,
                    transparent 100%);
            mask-image: linear-gradient(to bottom,
                    transparent 0%,
                    black 25%,
                    black 75%,
                    transparent 100%);
        }

        .time-picker-scroll-popup::-webkit-scrollbar {
            display: none;
            width: 0;
            height: 0;
        }

        .time-picker-scroll-popup {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        .time-option-popup {
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 500;
            scroll-snap-align: center;
            transition: all 0.2s;
            color: #999;
        }

        .time-option-popup.selected {
            color: var(--text-dark);
            font-weight: 700;
            font-size: 1.4rem;
        }

        .time-separator-popup {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-dark);
            padding: 0 4px;
            z-index: 3;
        }

        .time-picker-popup-footer {
            display: flex;
            border-top: 1px solid #eee;
        }

        .time-picker-cancel-btn,
        .time-picker-ok-btn {
            flex: 1;
            padding: 14px;
            border: none;
            background: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .time-picker-cancel-btn {
            color: #666;
            border-right: 1px solid #eee;
        }

        .time-picker-cancel-btn:hover {
            background: #f9f9f9;
        }

        .time-picker-ok-btn {
            color: var(--primary);
        }

        .time-picker-ok-btn:hover {
            background: #f0f7ff;
        }


        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 12px;
            flex-wrap: nowrap;
            margin-bottom: 20px;
        }

        .form-col {
            display: flex;
            flex-direction: column;
        }

        .form-col:nth-child(1) {
            flex: 0 0 35%;
        }

        .form-col:nth-child(2) {
            flex: 0 0 35%;
        }

        .form-col:nth-child(3) {
            flex: 0 0 25%;
        }

        .day-selector {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 8px;
        }

        .day-cb {
            display: none;
        }

        .day-label {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-light);
        }

        .day-cb:checked+.day-label {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .toggle-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            /* Faint divider */
            width: 100%;
        }

        .toggle-group label {
            margin-bottom: 0 !important;
            /* Override label block */
            flex-grow: 1;
            text-align: left;
            font-size: 1rem;
            color: var(--text-dark);
        }

        /* Toggle Switch Styling */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            border-radius: 24px;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: .4s;
        }

        input:checked+.slider {
            background-color: var(--primary);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        /* Hide default Checkbox for these toggles? Or wrapper? */
        /* Using standard checkbox logic in HTML is cleaner if we don't have switch CSS. */
        /* Let's rely on standard Checkbox logic with label alignment first. */

        input[type="checkbox"].toggle-slide {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }

        /* Task Item Extensions */
        .task-meta {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 4px;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .badge-time {
            background-color: #eef2ff;
            color: var(--primary);
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        .badge-recur {
            color: var(--secondary);
        }

        .note-preview {
            font-style: italic;
            color: #999;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 70%;
            cursor: pointer;
            display: block;
        }

        .note-preview.expanded {
            white-space: pre-wrap;
            overflow: visible;
            text-overflow: unset;
            overflow-wrap: anywhere;
            width: 100%;
            color: #555;
        }

        .status-badge-progress {
            background-color: #ecfdf5;
            color: var(--success);
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.75rem;
            border: 1px solid var(--success);
        }

        .status-badge-missed {
            background-color: #fef2f2;
            color: #ef4444;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.75rem;
            border: 1px solid #ef4444;
        }

        .task-missed {
            background-color: #fff1f2 !important;
            /* Reddish bg */
            opacity: 0.8;
        }

        /* Disable interaction for missed/early tasks */
        .task-item.disabled .cb-wrapper {
            pointer-events: none;
            opacity: 0.5;
        }

        /* Confirmation Modal */
        .confirm-modal-content {
            background: white;
            border-radius: 20px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.3s ease;
        }

        .confirm-btn {
            background-color: var(--success);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 32px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            height: 48px;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* --- Sidebar (Desktop) --- */
        .sidebar {
            width: var(--nav-width);
            background-color: var(--sidebar-bg);
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
            padding: 24px;
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-links {
            list-style: none;
            flex-grow: 1;
        }

        .nav-item {
            margin-bottom: 8px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 12px;
            text-decoration: none;
            color: var(--text-light);
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-link:hover {
            background-color: #f0f4ff;
            color: var(--primary);
        }

        .nav-link.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 8px rgba(40, 67, 147, 0.2);
        }

        .streak-container {
            background-color: #fff9e6;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--accent);
            margin-top: auto;
            margin-bottom: 20px;
        }

        .streak-count {
            font-size: 1.8rem;
            font-weight: 700;
            color: #dfa60a;
            display: block;
        }

        .streak-label {
            font-size: 0.9rem;
            color: #8a6d1c;
            font-weight: 500;
        }

        /* --- Main Content --- */
        .main-content {
            flex-grow: 1;
            overflow-y: scroll;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .mobile-header {
            display: none;
            /* Hidden on desktop */
            margin: 0;
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 90;
        }

        .hamburger {
            font-size: 1.5rem;
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            padding: 4px;
        }

        .content-padding {
            padding: 0;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .mobile-nav {
            display: none;
        }

        .hamburger {
            display: none;
        }

        /* --- Views --- */
        .view-section {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            padding: 0;
        }

        .view-section.active {
            display: block;
            opacity: 1;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h2.section-heading {
            margin-bottom: 24px;
            color: var(--primary);
            font-size: 1.8rem;
        }

        /* --- Today View Components --- */
        .header-content {
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .header-clock {
            text-align: right;
        }

        .clock-time {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            line-height: 1.2;
        }

        .clock-ampm {
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 500;
        }

        /* Progress Card */
        .progress-card {
            background: linear-gradient(135deg, #284393, #1e3372);
            color: white;
            padding: 24px;
            border-radius: 25px;
            /* Requested 25px */
            margin: 0 0 32px 0;
            box-shadow: 0 8px 24px rgba(40, 67, 147, 0.3);
            width: 100%;
            transition: all 0.3s ease;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 1rem;
            font-weight: 600;
        }

        .toggle-details-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            transition: transform 0.3s, background 0.2s;
            margin-left: 12px;
        }

        .toggle-details-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .toggle-details-btn.rotated {
            transform: rotate(180deg);
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            height: 10px;
            border-radius: 99px;
            overflow: hidden;
            margin-bottom: 0;
            /* Removed margin if details are collapsed */
        }

        .progress-fill {
            background: var(--secondary);
            height: 100%;
            width: 0%;
            border-radius: 99px;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 12px rgba(57, 210, 192, 0.4);
        }

        /* Expandable Details */
        .progress-details {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.4s ease, opacity 0.3s ease, margin-top 0.3s;
            margin-top: 0;
        }

        .progress-details.expanded {
            max-height: 300px;
            opacity: 1;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            text-align: center;
            margin-bottom: 20px;
        }

        .det-item {
            display: flex;
            flex-direction: column;
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .det-val {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .time-stats {
            display: flex;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.2);
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.9rem;
        }

        .cheer-msg {
            margin-top: 12px;
            font-weight: 600;
            min-height: 24px;
            font-size: 0.95rem;
            color: var(--secondary);
        }

        /* Collapsible Sections */
        .task-group {
            background-color: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .task-group-header {
            padding: 16px 24px;
            background-color: #f8f9fc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .task-group-header:hover {
            background-color: #f0f4ff;
        }

        .group-title {
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .task-list {
            list-style: none;
        }

        .task-item {
            display: flex;
            align-items: center;
            padding: 16px 16px 16px 24px;
            border-bottom: 1px solid #eee;
            position: relative;
        }

        .task-item:last-child {
            border-bottom: none;
        }

        /* Custom Checkbox */
        .cb-wrapper {
            position: relative;
            width: 32px;
            height: 32px;
            margin-right: 16px;
            flex-shrink: 0;
        }

        .native-cb {
            opacity: 0;
            width: 100%;
            height: 100%;
            position: absolute;
            cursor: pointer;
            z-index: 2;
        }

        .styled-cb {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 2px solid #888;
            /* Darker border for contrast */
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .native-cb:checked+.styled-cb {
            background-color: var(--secondary);
            border-color: var(--secondary);
        }

        .styled-cb::after {
            content: '';
            width: 6px;
            height: 12px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
            display: none;
            margin-top: -2px;
        }

        .native-cb:checked+.styled-cb::after {
            display: block;
        }

        .task-text {
            flex-grow: 1;
            font-size: 1.05rem;
            font-weight: 700;
            /* Bold as requested */
            transition: color 0.2s;
        }

        /* Delete Modal Styles */
        .delete-warn {
            background-color: #fff1f2;
            color: #991b1b;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .btn-cancel-alt {
            background-color: #f3f4f6;
            color: var(--text-dark);
            border: none;
            border-radius: 12px;
            padding: 12px 32px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            height: 48px;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-cancel-alt:hover {
            background-color: #e5e7eb;
        }

        .btn-delete-confirm {
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 32px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            height: 48px;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-delete-confirm:hover {
            background-color: #dc2626;
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }

        /* 3-Dots Menu */
        .task-actions {
            position: relative;
        }

        .kebab-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #666;
            /* Darker grey for contrast */
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            transition: bg 0.2s;
        }

        .kebab-btn:hover {
            background-color: #f0f0f0;
            color: var(--text);
        }

        .action-menu {
            position: fixed;
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            width: 140px;
            display: none;
            z-index: 1000;
            list-style: none;
            overflow: hidden;
            top: 0;
            left: 0;
            /* Set by JS */
        }

        .action-menu.show {
            display: block;
        }

        .action-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        .action-item:hover {
            background-color: #f9f9f9;
        }

        .action-item.delete {
            color: #e74c3c;
        }

        /* Add Task */
        .add-task-row {
            padding: 16px 24px;
            background-color: #fcfcfc;
            display: flex;
            gap: 12px;
        }

        .add-input {
            flex-grow: 1;
            padding: 10px 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            font-size: 1rem;
        }

        .add-btn-dashed {
            width: 100%;
            max-width: 800px;
            margin: 0 auto 20px auto;
            padding: 20px;
            background: transparent;
            border: 2px dashed #ddd;
            border-radius: 25px;
            color: var(--text-light);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-btn-dashed:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(57, 210, 192, 0.05);
        }

        .finish-day-btn {
            background-color: var(--secondary);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.2s;
            width: auto;
        }

        .finish-day-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* --- Calendar View --- */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .calendar-day {
            min-height: 100px;
        }

        .cal-day-header {
            text-align: center;
            font-weight: bold;
            padding: 10px 0;
            color: var(--text-light);
            font-size: 0.9rem;
            padding-bottom: 12px;
        }

        .cal-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background-color: #f9f9f9;
            font-size: 0.9rem;
            position: relative;
        }

        .cal-day.today {
            border: 2px solid var(--primary);
            font-weight: 700;
        }

        .cal-day.perfect {
            background-color: var(--secondary);
            color: white;
        }

        .cal-day.good {
            background-color: #a0e8df;
            color: #005a50;
        }

        .cal-day.bad {
            background-color: #eee;
            color: #999;
        }

        .cal-day.empty {
            background: transparent;
        }

        /* --- Overview View --- */
        #view-overview {
            padding: 20px;
        }

        /* Hide today-only elements when calendar or overview views are active */
        #view-calendar.active~* .today-only,
        #view-overview.active~* .today-only,
        .view-section.active:not(#view-today)~#view-today .today-only {
            display: none !important;
        }

        /* Alternative: hide when view-today is not active */
        #view-today:not(.active) .today-only {
            display: none !important;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-val {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }

        .stat-title {
            color: var(--text-light);
            font-size: 0.95rem;
        }

        /* Footer Reset */
        .reset-section {
            padding: 40px 0;
            text-align: center;
        }

        .reset-btn {
            background: transparent;
            border: 2px solid #ddd;
            padding: 12px 30px;
            border-radius: 30px;
            color: var(--text-light);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reset-btn:hover {
            border-color: #e74c3c;
            color: #e74c3c;
        }

        /* --- Media Queries --- */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
                height: auto;
                display: block;
                overflow-y: auto;
                /* Enable scroll on mobile */
                overflow-x: hidden;
            }



            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                transform: translateX(-100%);
                box-shadow: 2px 0 12px rgba(0, 0, 0, 0.1);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .mobile-header {
                display: flex;
                padding: 5px 10px;
            }

            .mobile-nav {
                display: flex;
                justify-content: space-around;
                background: white;
                border-bottom: none;
                padding: 8px 0;
                /* Sticky Behavior */
                position: -webkit-sticky;
                /* Safari */
                position: sticky;
                top: 0;
                z-index: 100;
                width: 100%;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                /* Subtle shadow when sticky */
            }

            .mobile-nav-tab {
                flex: 1;
                text-align: center;
                padding: 8px 12px;
                font-size: 0.9rem;
                font-weight: 600;
                color: var(--text-light);
                cursor: pointer;
                border-bottom: 2px solid #e5e7eb;
                transition: all 0.2s;
            }

            .mobile-nav-tab.active {
                color: var(--primary);
                border-bottom-color: var(--primary);
            }

            .main-content {
                height: auto;
                overflow: visible;
                padding-top: 10px;
            }

            /* Reduced calendar cell height on mobile */
            .calendar-day {
                min-height: 60px !important;
            }

            /* Responsive Calendar Nav */
            .calendar-nav {
                width: 100%;
                justify-content: space-between;
                margin-top: 8px;
            }

            #calendar-month-year {
                text-align: center;
                flex: 1;
            }

            .content-padding {
                padding: 0;
            }

            .view-section {
                padding: 0;
            }

            .progress-card {
                margin-left: 0 !important;
                margin-right: 0 !important;
            }

            .header-content {
                margin-left: 0 !important;
                margin-right: 0 !important;
            }

            .task-list {
                margin-left: 0 !important;
                margin-right: 0 !important;
            }
        }

        /* Utility */
        .hidden {
            display: none !important;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 95;
            display: none;
        }

        .overlay.show {
            display: block;
        }

        /* --- AUTH MODAL --- */
        .auth-container {
            text-align: center;
        }

        .auth-input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .auth-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }

        .auth-switch {
            margin-top: 16px;
            color: var(--text-light);
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: underline;
        }

        .auth-link {
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
        }

        .auth-link:hover {
            opacity: 0.8;
        }

        /* --- PROFILES & AUTH UPDATES --- */
        .google-btn {
            background: white;
            color: #333;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .google-btn:hover {
            background: #f9f9f9;
        }

        .profile-section {
            margin-top: auto;
            /* Push to bottom */
            width: 100%;
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            text-align: center;
        }

        .profile-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .profile-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .profile-email {
            font-size: 0.75rem;
            color: var(--text-light);
            word-break: break-all;
            max-width: 100%;
        }

        .logout-link {
            background: none;
            border: none;
            color: #e74c3c;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
        }

        /* Button Radius Updates */
        .auth-btn,
        .confirm-btn,
        .btn-start-task,
        .btn-end-task,
        .lifecycle-btn {
            border-radius: 12px;
            /* Consistent radius */
        }
    </style>
</head>

<body>

    <!-- Overlay for Mobile Sidebar -->
    <div id="overlay" class="overlay" onclick="toggleSidebar()"></div>

    <!-- FAILSAFE: Ensure Login Screen appears if something crashses -->
    <script>
        // DISABLED: Forced login timeout - allows public access to History/Overview without auth prompt
        /*
        setTimeout(() => {
            const authModal = document.getElementById('auth-modal');
            const appView = document.getElementById('app-view');
            if (!authModal || !appView) return;

            const authStyle = window.getComputedStyle(authModal);
            const appStyle = window.getComputedStyle(appView);

            const isAppHidden = appStyle.display === 'none';
            const isAuthHidden = authStyle.display === 'none' || authStyle.opacity === '0';

            // Check if Global Crash prevented Init
            if (isAppHidden && isAuthHidden) {
                console.warn("Failsafe: Force showing Login Modal.");

                // Nuclear cleanup of blocking layers
                const sidebarOverlay = document.getElementById('overlay');
                if (sidebarOverlay) {
                    sidebarOverlay.classList.remove('show');
                    sidebarOverlay.style.display = 'none';
                }

                authModal.style.display = 'flex';
                authModal.style.opacity = '1'; // Direct set
                authModal.style.pointerEvents = 'auto'; // Force clickable

                const errEl = document.getElementById('auth-error');
                if (errEl) {
                    if (!window.supabase) errEl.innerText="Supabase SDK not loaded (Reload Page).";
                    else errEl.innerText="App Init stalled. Forced Login.";
                }
            }
        }, 3000); // Increased to 3s to allow slow connection
        */
    </script>

    <!-- Sidebar -->
    <nav id="sidebar" class="sidebar">
        <div class="sidebar-logo">
            DailyCheck
        </div>
        <div class="nav-menu">
            <a class="nav-item active" onclick="switchView('today')" data-view="today">
                <div class="nav-icon"></div>
                <span class="nav-label">Today</span>
            </a>
            <a class="nav-item" onclick="switchView('care-hub')" data-view="care-hub">
                <div class="nav-icon"></div>
                <span class="nav-label">Care Hub</span>
            </a>
            <a class="nav-item" onclick="switchView('calendar')" data-view="calendar">
                <div class="nav-icon"></div>
                <span class="nav-label">Calendar</span>
            </a>
            <a class="nav-item" onclick="switchView('overview')" data-view="overview">
                <div class="nav-icon"></div>
                <span class="nav-label">Dashboard</span>
            </a>
        </div>

        <div class="streak-container">
            <span class="streak-label">Current Streak</span>
            <span id="streak-display" class="streak-count">0 Days</span>
            <span class="streak-label">Keep it up! </span>
        </div>

        <!-- Spacer & Account -->
        <div style="width:100%; height:1px; background:rgba(0,0,0,0.05); margin: 16px 0;"></div>

        <div class="nav-item" onclick="openAccountModal()" style="justify-content: flex-start; cursor: pointer;">
            <div id="sidebar-photo-container"
                style="width:32px; height:32px; border-radius:50%; overflow:hidden; background:#f3f4f6; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                <img id="sidebar-photo" style="width:100%; height:100%; object-fit:cover; display:none;" alt="Profile">
                <span id="sidebar-fallback" style="font-size:1.2rem;"></span>
            </div>
            <span id="sidebar-username" class="nav-label">Account</span>
        </div>
    </nav>

    <!-- Account Modal -->
    <div id="account-modal" class="modal-overlay">
        <div class="modal-card">
            <div id="profile-photo-container"
                style="margin:0 auto 16px auto; width:80px; height:80px; border-radius:50%; overflow:hidden; background:#f3f4f6; display:flex; align-items:center; justify-content:center;">
                <img id="profile-photo" style="width:100%; height:100%; object-fit:cover; display:none;" alt="Profile">
                <span id="profile-fallback" style="font-size:2.5rem;"></span>
            </div>

            <!-- Editable Username Section (Now the main heading) -->
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px; justify-content:center;">
                <input id="acc-username-input" type="text" placeholder="Set your username"
                    style="flex:0 1 auto; max-width:250px; padding:8px 12px; border:1px solid #ddd; border-radius:8px; font-size:1.3rem; font-weight:600; display:none; text-align:center;">
                <h2 id="acc-username-display"
                    style="margin:0; color:var(--text-dark); font-weight:700; font-size:1.5rem;"></h2>
                <button id="acc-username-edit-btn" onclick="toggleUsernameEdit()"
                    style="background:none; border:none; cursor:pointer; font-size:1.2rem; padding:4px 8px; border-radius:6px; transition:background 0.2s;"
                    onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'"></button>
            </div>

            <p id="acc-email-display"
                style="color:var(--text-light); margin-bottom:24px; font-weight:500; font-size:0.9rem;"></p>

            <div class="modal-actions" style="display:flex; flex-direction:column; gap:12px;">
                <button class="lifecycle-btn btn-end-task" onclick="doLogout()"
                    style="width:100%; justify-content:center; padding:12px;">Log Out</button>
                <button class="lifecycle-btn" onclick="closeAccountModal()"
                    style="background:#f3f4f6; color:#333; width:100%; justify-content:center; padding:12px;">Close</button>
            </div>
        </div>
    </div>

    <!-- Mobile Header -->
    <header class="mobile-header">
        <div style="font-weight: 600; font-size: 1.1rem;">DailyCheck</div>

        <!-- Mobile Profile Button -->
        <div onclick="openAccountModal()"
            style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:4px 8px; border-radius:12px; transition:background 0.2s;"
            onmouseover="this.style.background='rgba(255,255,255,0.1)'"
            onmouseout="this.style.background='transparent'">
            <div id="mobile-photo-container"
                style="width:32px; height:32px; border-radius:50%; overflow:hidden; background:#f3f4f6; display:flex; align-items:center; justify-content:center;">
                <img id="mobile-photo" style="width:100%; height:100%; object-fit:cover; display:none;" alt="Profile">
                <span id="mobile-fallback" style="font-size:1.2rem;"></span>
            </div>
            <span id="mobile-username" style="font-size:0.9rem; font-weight:500; color:white;">Account</span>
        </div>
    </header>

    <!-- Global Mobile Navigation Tabs (Sticky) -->
    <div id="global-mobile-nav" class="mobile-nav hidden">
        <div class="mobile-nav-tab active" onclick="switchView('today')" data-view="today">Today</div>
        <div class="mobile-nav-tab" onclick="switchView('care-hub')" data-view="care-hub">Care Hub</div>
        <div class="mobile-nav-tab" onclick="switchView('calendar')" data-view="calendar">Calendar</div>
        <div class="mobile-nav-tab" onclick="switchView('overview')" data-view="overview">Dashboard</div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-padding">

            <!-- Auth Modal -->
            <div id="auth-modal" class="modal-overlay" style="display:flex;">
                <div class="modal-card auth-container">
                    <h2 id="auth-title" style="margin-bottom:8px;">Welcome Back</h2>
                    <p id="auth-subtitle" style="color:#666; margin-bottom:20px;">Sign in to sync your tasks</p>

                    <button class="auth-btn google-btn" onclick="loginWithGoogle()">
                        <svg width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M17.64 9.2c0-.637-.057-1.252-.164-1.841H9v3.481h4.844a4.14 4.14 0 0 1-1.796 2.716v2.259h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"
                                fill="#4285F4" />
                            <path
                                d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.836.86-3.048.86-2.344 0-4.328-1.584-5.036-3.719H.957v2.332A8.997 8.997 0 0 0 9 18z"
                                fill="#34A853" />
                            <path
                                d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"
                                fill="#FBBC05" />
                            <path
                                d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 7.29C4.672 5.155 6.656 3.58 9 3.58z"
                                fill="#EA4335" />
                        </svg>
                        <span>Sign in with Google</span>
                    </button>

                    <div style="text-align:center; margin: 10px 0; color:#aaa; font-size:0.8rem;">OR</div>

                    <input type="email" id="auth-email" class="auth-input" placeholder="Email">
                    <input type="password" id="auth-pass" class="auth-input" placeholder="Password">

                    <button class="auth-btn" id="auth-submit-btn" onclick="handleAuth()">Sign In</button>

                    <div class="auth-switch-container"
                        style="margin-top:16px; font-size:0.9rem; color:var(--text-light);">
                        Don't have an account? <span id="auth-switch-text" class="auth-link"
                            onclick="toggleAuthMode()">Sign Up</span>
                    </div>
                    <div id="forgot-password-link" class="auth-switch" onclick="showForgotPasswordModal()"
                        style="margin-top:8px; font-size:0.85rem;">
                        Forgot Password?
                    </div>
                    <div id="auth-error" style="color:red; margin-top:10px; font-size:0.9rem;"></div>
                </div>
            </div>



            <!-- Forgot Password Modal -->
            <div id="forgot-password-modal" class="modal-overlay" style="display:none;">
                <div class="modal-card auth-container">
                    <h2 style="margin-bottom:8px;">Reset Password</h2>
                    <p style="color:#666; margin-bottom:20px;">Enter your email to receive a reset link</p>

                    <input type="email" id="reset-email" class="auth-input" placeholder="Email">

                    <button class="auth-btn" id="reset-submit-btn" onclick="sendPasswordResetEmail()">Send Reset
                        Link</button>

                    <div class="auth-switch" onclick="closeForgotPasswordModal()" style="margin-top:12px;">
                        Back to Login
                    </div>
                    <div id="reset-error" style="color:red; margin-top:10px; font-size:0.9rem;"></div>
                    <div id="reset-success" style="color:green; margin-top:10px; font-size:0.9rem;"></div>
                </div>
            </div>

            <!-- TODAY VIEW -->
            <div id="debug-log"
                style="position:fixed; top:0; left:0; width:100%; background:red; color:white; z-index:9999; display:none;">
            </div>
            <!-- APP VIEW (Hidden by default until init/auth) -->
            <div id="app-view" class="app-container hidden">
                <!-- Global Mobile Navigation Tabs -->
                <!-- Mobile Nav Moved Outside for Sticky Behavior -->

                <div id="view-today" class="view-section active" style="display:none;">
                    <!-- Hidden by default until auth -->

                    <div class="header-content" style="padding-top: 16px;">
                        <div>
                            <h1 id="current-date-display">Thursday</h1>
                            <p id="current-day-detail">December 11, 2025</p>
                        </div>
                        <div class="header-clock">
                            <div id="clock-time" class="clock-time">--:--</div>
                            <div id="clock-ampm" class="clock-ampm">--</div>
                        </div>
                    </div>

                    <!-- Progress Card moved INSIDE view-today -->
                    <div class="progress-card">
                        <!-- Sticky Header Wrapper -->
                        <div class="progress-sticky-top">
                            <div class="progress-header">
                                <span>Daily Progress</span>
                                <div style="display:flex; align-items:center;">
                                    <span id="progress-text">0%</span>
                                    <button class="toggle-details-btn" onclick="toggleProgressDetails()">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none"
                                            stroke="currentColor" stroke-width="3" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <path d="M6 9l6 6 6-6" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill"></div>
                            </div>
                        </div>

                        <!-- Expanded Details -->
                        <!-- NEW Progress Details V2 (Clean Implementation) -->
                        <div id="progress-details-v2" class="progress-v2-container">
                            <div class="progress-v2-grid">
                                <!-- Tasks Column -->
                                <div class="progress-v2-col">
                                    <h4 class="progress-v2-title">Tasks</h4>
                                    <div class="progress-v2-row">
                                        <span>Total</span> <span id="d-total">0</span>
                                    </div>
                                    <div class="progress-v2-row">
                                        <span>Completed</span> <span id="d-done" style="color:#7cebda">0</span>
                                    </div>
                                    <div class="progress-v2-row">
                                        <span>To Do</span> <span id="d-todo">0</span>
                                    </div>
                                </div>
                                <!-- Time Column -->
                                <div class="progress-v2-col">
                                    <h4 class="progress-v2-title">Time</h4>
                                    <div class="progress-v2-row">
                                        <span>Allocated</span> <span id="d-alloc">0h 0 m</span>
                                    </div>
                                    <div class="progress-v2-row">
                                        <span>Sleep</span> <span id="d-sleep-stat">0h 0 m</span>
                                    </div>
                                    <div class="progress-v2-row">
                                        <span>Unallocated</span> <span id="d-unalloc"
                                            style="color:rgba(255,255,255,0.7)">0h 0 m</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Medications Section (Full Width) -->
                            <div
                                style="margin-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px;">
                                <h4 class="progress-v2-title" style="margin-bottom:10px; color:white;">Active
                                    Medications</h4>
                                <div id="progress-meds-list" style="display:flex; flex-direction:column; gap:8px;">
                                    <!-- Dynamic Meds rendered here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- Closing progress-card -->
            </div>
        </div>
        <div id="cheer-msg" class="cheer-msg"></div>
        </div>

        <div id="task-container" class="today-only">
            <!-- Tasks Render Here -->
        </div>

        <!-- Add Task Button (Restored) -->
        <button onclick="openTaskModal()" class="add-btn-dashed today-only">
            + Add Task
        </button>

        <div class="reset-section today-only">
            <button class="finish-day-btn" onclick="showEndDaySummary()">Finish Day </button>
        </div>
        </div> <!-- End view-today -->

        <!-- CALENDAR VIEW -->
        <div id="view-calendar" class="view-section">
            <h2 class="section-heading" style="margin-bottom: 32px;">Calendar</h2>

            <!-- Calendar Header: View Switcher & Navigation -->
            <div class="calendar-controls-bar"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
                <!-- Left: View Switcher -->
                <div class="calendar-view-switcher" style="display: flex; align-items: center; gap: 16px;">
                    <span style="font-size: 14px; font-weight: 500; color: var(--text-light);">Calendar View</span>
                    <div class="view-toggle-group"
                        style="display: flex; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; background: white;">
                        <button onclick="switchCalendarView('week')"
                            style="padding: 8px 16px; background: white; border: none; font-size: 13px; font-weight: 500; color: var(--text-light); cursor: pointer; border-right: 1px solid #e5e7eb;">WEEK</button>
                        <button onclick="switchCalendarView('month')"
                            style="padding: 8px 16px; background: #f3f4f6; border: none; font-size: 13px; font-weight: 600; color: var(--primary); cursor: pointer; border-right: 1px solid #e5e7eb;">MONTH</button>
                        <button onclick="switchCalendarView('year')"
                            style="padding: 8px 16px; background: white; border: none; font-size: 13px; font-weight: 500; color: var(--text-light); cursor: pointer;">YEAR</button>
                    </div>
                </div>

                <!-- Right: Month Navigation -->
                <div class="calendar-nav" style="display: flex; align-items: center; gap: 16px;">
                    <button class="calendar-nav-btn" onclick="navigateCalendar(-1)"
                        style="background: none; border: 2px solid var(--primary); border-radius: 8px; cursor: pointer; color: var(--primary); width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                    </button>
                    <h3 id="calendar-month-year"
                        style="text-align: center; margin: 0; font-size: 1.5rem; font-weight: 500; color: var(--text-dark); min-width: 220px;">
                        December 2025</h3>
                    <button class="calendar-nav-btn" onclick="navigateCalendar(1)"
                        style="background: none; border: 2px solid var(--primary); border-radius: 8px; cursor: pointer; color: var(--primary); width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>
                    <!-- Today Button (Moved to Right) -->
                    <button id="today-nav-btn" onclick="resetToToday()"
                        style="width: 36px; height: 36px; border-radius: 8px; background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <span id="today-btn-date">--</span>
                    </button>
                </div>
            </div>

            <!-- Day Headers -->
            <div class="calendar-day-headers"
                style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; background: #6366f1; border-radius: 8px 8px 0 0; padding: 12px 4px; margin-bottom: 0;">
                <div
                    style="text-align: center; color: white; font-weight: 700; font-size: 14px; text-transform: uppercase;">
                    Sun</div>
                <div
                    style="text-align: center; color: white; font-weight: 700; font-size: 14px; text-transform: uppercase;">
                    Mon</div>
                <div
                    style="text-align: center; color: white; font-weight: 700; font-size: 14px; text-transform: uppercase;">
                    Tue</div>
                <div
                    style="text-align: center; color: white; font-weight: 700; font-size: 14px; text-transform: uppercase;">
                    Wed</div>
                <div
                    style="text-align: center; color: white; font-weight: 700; font-size: 14px; text-transform: uppercase;">
                    Thu</div>
                <div
                    style="text-align: center; color: white; font-weight: 700; font-size: 14px; text-transform: uppercase;">
                    Fri</div>
                <div
                    style="text-align: center; color: white; font-weight: 700; font-size: 14px; text-transform: uppercase;">
                    Sat</div>
            </div>

            <!-- Calendar Grid -->
            <div class="calendar-grid" id="calendar-grid"
                style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; padding: 4px; background: white; border-radius: 0 0 8px 8px; border: 1px solid #e5e7eb; border-top: none;">
                <!-- Generated by renderCalendar() -->
            </div>
        </div>

        <!-- CARE HUB VIEW -->
        <div id="view-care-hub" class="view-section">
            <h2 class="section-heading">Care Hub</h2>
            <!-- Active Meds Section -->
            <div id="active-meds-container" style="margin-bottom: 32px; display: none;">
                <h3 class="section-heading" style="font-size: 1rem; margin-bottom: 16px;">Active Medications</h3>
                <div id="active-meds-grid" class="care-hub-grid"
                    style="grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
                    <!-- Med Cards Injected Here -->
                </div>
            </div>


            <div id="care-hub-content">
                <!-- Libraries will be injected here via JS -->
            </div>
        </div>

        <!-- OVERVIEW VIEW -->
        <div id="view-overview" class="view-section">
            <h2 class="section-heading">Dashboard</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">Current Streak</div>
                    <div id="stat-current-streak" class="stat-val">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Best Streak</div>
                    <div id="stat-best-streak" class="stat-val">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Completion Rate</div>
                    <div id="stat-completion-rate" class="stat-val">0%</div>
                </div>
            </div>
        </div>

        </div>
    </main>


    <!-- Global Action Menu -->
    <ul id="global-action-menu" class="action-menu">
        <li class="action-item" onclick="triggerGlobalAction('settings')">Settings</li>
        <li class="action-item" onclick="triggerGlobalAction('up')">Move Up</li>
        <li class="action-item" onclick="triggerGlobalAction('down')">Move Down</li>
        <li class="action-item delete" onclick="triggerGlobalAction('delete')">Delete</li>
    </ul>

    <!-- End Day Modal -->
    <div id="end-day-modal" class="modal-overlay">
        <div class="modal-card">
            <h2 class="modal-title">Day Complete!</h2>
            <p style="color: var(--text-light);">Great work focusing on your daily tasks.</p>

            <div class="modal-stats">
                <div class="m-stat-item">
                    <span id="m-completion" class="m-stat-val">0%</span>
                    <span class="m-stat-label">Complete</span>
                </div>
                <div class="m-stat-item">
                    <span id="m-streak" class="m-stat-val">0</span>
                    <span class="m-stat-label">Day Streak</span>
                </div>
            </div>

            <div id="m-streak-msg" class="modal-streak-msg"> Streak Increased!</div>

            <div class="modal-buttons">
                <!-- Removed Cancel button per request implication or keep it? User asked "instead of Start New Day... the button should be Done" -->
                <!-- I'll keep Cancel just in case, but rename Primary. Or just have Done? -->
                <!-- User said: "instead of Start New Day ... button should be Done". I'll keep Cancel for UI safety but change Primary -->
                <button class="btn-modal-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn-modal-primary" onclick="confirmEndDay()">Done</button>
            </div>
        </div>
    </div>

    <!-- Time Picker Popup Modal -->
    <div id="time-picker-modal" class="modal-overlay" style="display:none;">
        <div class="time-picker-popup-card">
            <div class="time-picker-popup-header">
                <span id="time-picker-title">Select Time</span>
            </div>

            <div class="time-picker-popup-body">
                <div class="time-picker-container-popup">
                    <div class="time-picker-scroll-popup" id="popup-hour-scroll">
                        <!-- Hours populated by JS -->
                    </div>
                    <span class="time-separator-popup">:</span>
                    <div class="time-picker-scroll-popup" id="popup-min-scroll">
                        <!-- Minutes populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Tomorrow Toggle (only shown for end time when end <start) -->
            <div id="tomorrow-toggle-container" style="display: none; padding: 12px; border-top: 1px solid #e0e0e0;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
                    <input type="checkbox" id="tomorrow-toggle" style="cursor: pointer; width: 18px; height: 18px;">
                    <span style="font-size: 14px; color: var(--text-dark); font-weight: 500;">Ends Tomorrow</span>
                </label>
            </div>

            <div class="time-picker-popup-footer">
                <button class="time-picker-cancel-btn" onclick="closeTimePicker(false)">Cancel</button>
                <button class="time-picker-ok-btn" onclick="closeTimePicker(true)">OK</button>
            </div>
        </div>
    </div>

    <!-- Day Tasks Popup -->
    <div id="day-popup-modal" class="modal-overlay" style="display:none;">
        <div class="day-popup-card"
            style="background: white; border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
            <div class="day-popup-header"
                style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e0e0e0;">
                <h3 id="day-popup-date" style="margin: 0; font-size: 1.25rem; font-weight: 600;">December 13, 2025</h3>
                <button onclick="closeDayPopup()"
                    style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light); padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;"></button>
            </div>

            <div class="day-popup-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                <div id="day-tasks-list" style="display: flex; flex-direction: column; gap: 12px;">
                    <!-- Tasks rendered here -->
                </div>

                <div class="day-popup-empty" id="day-popup-empty"
                    style="display:none; text-align: center; padding: 40px 20px; color: var(--text-light);">
                    No tasks for this day
                </div>
            </div>

            <div class="day-popup-footer"
                style="display: flex; gap: 12px; padding: 20px; border-top: 1px solid #e0e0e0;">
                <button class="btn-add-task" onclick="addTaskFromCalendar()"
                    style="flex: 1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    + Add Task
                </button>
                <button class="btn-add-event" onclick="addEventFromCalendar()"
                    style="flex: 1; padding: 12px; background: #f5f5f5; color: var(--text-dark); border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    + Add Event
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="delete-modal" class="modal-overlay">
        <div class="confirm-modal-content">
            <h2 style="font-size: 1.25rem; margin-bottom: 12px; color: #ef4444;">Delete Task?</h2>
            <div class="delete-warn">
                This action cannot be undone. Are you sure?
            </div>

            <div class="toggle-group" style="justify-content:center; border:none; margin-bottom: 20px;">
                <label for="del-toggle" style="flex-grow:0; margin-right:12px; cursor:pointer;">I understand</label>
                <input type="checkbox" id="del-toggle" class="native-cb" onchange="toggleDeleteConfirm()"
                    style="width:20px; height:20px;">
            </div>

            <div style="display:flex; justify-content:center; gap:12px; align-items:center;">
                <button class="btn-cancel-alt" onclick="closeDeleteModal()">Cancel</button>
                <button id="btn-delete-act" class="btn-delete-confirm" onclick="executeDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- View Task Modal (ReadOnly + Actions) -->
    <div id="view-task-modal" class="modal-overlay"
        style="display:none; align-items: center; justify-content: center; z-index: 1050;">
        <div class="modal-card" style="text-align: left; max-width: 400px; position: relative;">
            <button onclick="closeViewTaskModal()"
                style="position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 24px; color: #9ca3af; cursor: pointer; line-height: 1; padding: 4px;">
                
            </button>

            <h2 id="vt-title" style="margin: 0 0 8px 0; font-size: 1.5rem; color: var(--text-dark);">Task Name</h2>
            <div id="vt-date" style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 24px;">Sat, Dec 14
            </div>

            <div style="margin-bottom: 24px;">
                <div class="vt-row" style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                    <span style="width:24px; text-align:center;"></span>
                    <span id="vt-time" style="font-weight:500; color:var(--text-dark);">10:00 - 11:00</span>
                </div>
                <div id="vt-loc-row" class="vt-row"
                    style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                    <span style="width:24px; text-align:center;"></span>
                    <span id="vt-location" style="color:var(--text-dark);">Location</span>
                </div>
                <div id="vt-desc-row" class="vt-row" style="display:flex; align-items:start; gap:12px;">
                    <span style="width:24px; text-align:center; padding-top:2px;"></span>
                    <div id="vt-desc" style="color:var(--text-light); line-height:1.4;">Note content...</div>
                </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 32px;">
                <button onclick="editCurrentViewTask()"
                    style="flex:1; padding: 10px; border: none; background: var(--primary); border-radius: 8px; font-weight: 500; color: white; cursor:pointer;">
                     Settings
                </button>
                <button onclick="deleteCurrentViewTask()"
                    style="flex:1; padding: 10px; border: 1px solid #fee2e2; background: #fef2f2; border-radius: 8px; font-weight: 500; color: #dc2626; cursor:pointer;">
                     Delete
                </button>
            </div>
            <input type="hidden" id="vt-id">
        </div>
    </div>

    <!-- Task Details Modal (Edit/Add) -->
    <div id="task-modal" class="modal-overlay">
        <div class="modal-card" style="text-align: left; max-width: 500px; position: relative;">
            <button onclick="closeTaskModal()"
                style="position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 24px; color: #9ca3af; cursor: pointer; line-height: 1; padding: 4px; border-radius: 4px; transition: background 0.2s;"
                onmouseover="this.style.background='#f3f4f6'; this.style.color='#6b7280'"
                onmouseout="this.style.background='none'; this.style.color='#9ca3af'">
                
            </button>

            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px;">
                <h2 class="modal-title" id="tm-title" style="margin: 0;">Add Task</h2>
                <!-- Adjust padding right to avoid overlap with close button -->
                <div id="tm-header-date"
                    style="font-size: 0.9rem; color: var(--text-light); font-weight: 500; padding-top: 4px; margin-right: 32px;">
                </div>
            </div>

            <input type="hidden" id="tm-section">
            <input type="hidden" id="tm-id">


            <div class="form-group">
                <label id="tm-name-label" class="form-label">Task Name</label>
                <input type="text" id="tm-text" class="form-input" placeholder="e.g. Morning Jog">
            </div>

            <div class="form-row">
                <div class="form-col">
                    <label class="form-label">Start Time</label>
                    <button type="button" class="time-picker-btn" onclick="openTimePicker('start')">
                        <span id="start-time-display">00:00</span>
                    </button>
                    <input type="hidden" id="tm-start">
                </div>
                <div class="form-col">
                    <label class="form-label">End Time</label>
                    <button type="button" class="time-picker-btn" onclick="openTimePicker('end')">
                        <span id="end-time-display">00:00</span>
                    </button>
                    <input type="hidden" id="tm-end">
                    <input type="hidden" id="tm-ends-next-day" value="false">
                </div>
                <div class="form-col">
                    <label class="form-label">Duration</label>
                    <input type="text" id="tm-duration" class="form-input" placeholder="e.g. 1h 30m"
                        oninput="formatDurationInput(this); calculateTimeFromDuration()"
                        style="background:#fff; color: var(--text-dark);">
                </div>
            </div>

            <!-- Time Allocation Timeline -->
            <div id="time-allocation-timeline"
                style="display:none; margin-top:16px; margin-bottom:24px; padding:16px; background:#f8f9fa; border-radius:12px; border:1px solid #e0e0e0;">

                <!-- Header with dropdown arrow -->
                <div onclick="toggleTimelineExpand()"
                    style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;">
                    <div style="font-size:0.85rem; font-weight:600; color:var(--text-dark);">Time Availability</div>
                    <svg id="timeline-arrow" style="width: 20px; height: 20px; transition: transform 0.3s ease;"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>

                <!-- Collapsible content -->
                <div id="timeline-content" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease;">
                    <div style="padding: 12px 0 15px;">
                        <div id="timeline-container"
                            style="height:40px; background:#fff; border-radius:8px; position:relative; overflow:hidden; border:1px solid #ddd;">
                            <!-- Timeline segments rendered here -->
                        </div>
                        <div
                            style="display:flex; gap:16px; margin-top:12px; font-size:0.75rem; color:var(--text-light); justify-content:center;">
                            <span><span
                                    style="display:inline-block; width:12px; height:12px; background:#4ade80; border-radius:3px; margin-right:4px;"></span>Available</span>
                            <span><span
                                    style="display:inline-block; width:12px; height:12px; background:#f87171; border-radius:3px; margin-right:4px;"></span>Allocated</span>
                            <span><span
                                    style="display:inline-block; width:12px; height:12px; background:#fbbf24; border-radius:3px; margin-right:4px;"></span>Selected</span>
                        </div>

                        <!-- Current Time Progress Indicator -->
                        <div id="current-time-progress" style="margin-top: 16px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                                <span style="font-size: 12px; font-weight: 500; color: var(--text-dark);">Current
                                    Time</span>
                            </div>
                            <div
                                style="position: relative; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: visible;">
                                <!-- Past time fill (darker grey) -->
                                <div id="time-progress-fill"
                                    style="position: absolute; left: 0; top: 0; height: 100%; background: #9ca3af; border-radius: 4px; transition: width 0.3s ease;">
                                </div>
                                <!-- Current time dot with label above -->
                                <div id="time-progress-dot"
                                    style="position: absolute; top: 50%; transform: translate(-50%, -50%); transition: left 0.3s ease;">
                                    <!-- Time label above dot -->
                                    <div id="current-time-label"
                                        style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); font-size: 12px; font-weight: 600; color: var(--primary); white-space: nowrap;">
                                    </div>
                                    <!-- Dot -->
                                    <div
                                        style="width: 16px; height: 16px; background: white; border: 3px solid var(--primary); border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Time Overlap Warning -->
                        <div id="conflict-warning"
                            style="display:none; margin-top:12px; padding:10px; background:#fef2f2; border:1px solid #fca5a5; border-radius:8px; color:#dc2626; font-size:0.85rem;">
                             <span id="conflict-message"></span>
                        </div>
                    </div>
                </div>
                <!-- End collapsible content -->
            </div>

            <!-- Recurring + Reminder Toggles (Outside dropdown) -->
            <div id="tm-recur-group" class="toggle-group">
                <label for="tm-recur">Recurring Task?</label>
                <input type="checkbox" id="tm-recur" class="toggle-slide"
                    onchange="toggleRecurOptions(); updateTimelineIfVisible()">
            </div>

            <div id="recur-options"
                style="display:none; padding-bottom: 16px; border-bottom: 1px solid rgba(0,0,0,0.05); margin-bottom: 24px;">
                <label style="display:block; margin-bottom:12px; margin-top:4px;">Repeat On:</label>
                <div class="days-grid">
                    <label><input type="checkbox" class="day-cb" value="Mon"><span class="day-label">M</span></label>
                    <label><input type="checkbox" class="day-cb" value="Tue"><span class="day-label">T</span></label>
                    <label><input type="checkbox" class="day-cb" value="Wed"><span class="day-label">W</span></label>
                    <label><input type="checkbox" class="day-cb" value="Thu"><span class="day-label">Th</span></label>
                    <label><input type="checkbox" class="day-cb" value="Fri"><span class="day-label">F</span></label>
                    <label><input type="checkbox" class="day-cb" value="Sat"><span class="day-label">S</span></label>
                    <label><input type="checkbox" class="day-cb" value="Sun"><span class="day-label">Su</span></label>
                </div>
            </div>

            <div class="toggle-group">
                <label for="tm-remind">Set Reminder/Alarm?</label>
                <input type="checkbox" id="tm-remind" class="toggle-slide" onchange="toggleRemindOptions()">
            </div>

            <div id="remind-options" style="display:none; margin-bottom: 24px;">
                <div style="display:flex; gap:10px;">
                    <input type="number" id="tm-remind-val" value="10" placeholder="10">
                    <select id="tm-remind-unit" style="flex-grow:1;">
                        <option value="min">Minutes Before</option>
                        <option value="hr">Hours Before</option>
                    </select>
                </div>
            </div>

            <!-- Date is dynamically hidden if Recurring or if default Task Mode as requested -->
            <div id="tm-date-group" class="form-group">
                <label class="form-label">Date (One-time)</label>
                <input type="date" id="tm-date" class="form-input" onchange="updateTimelineIfVisible()"
                    onclick="try{this.showPicker()}catch(e){}" onkeydown="return false">
            </div>

            <!-- Location Field (Moved here for Events) -->
            <div id="tm-location-group" class="form-group" style="display: none;">
                <label class="form-label">Location <span
                        style="font-weight: normal; color: #9ca3af;">(Optional)</span></label>
                <input type="text" id="tm-location" class="form-input" placeholder="Add location">
            </div>

            <div class="form-group">
                <label class="form-label">Note</label>
                <textarea id="tm-note" class="form-input" rows="3" placeholder="Add details..."></textarea>
            </div>

            <!-- Color Picker -->
            <div class="form-group" style="margin-bottom: 24px;">
                <label class="modal-label">Color</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="color" id="tm-color" value="#e0f2fe"
                        style="border: none; width: 40px; height: 40px; padding: 0; cursor: pointer; background: none;">
                    <span style="font-size: 0.9rem; color: var(--text-light);">(Optional)</span>
                </div>
            </div>

            <!-- Error Message Container -->
            <div id="tm-error-msg"
                style="display:none; color: #ef4444; font-size: 0.9rem; margin-top: 16px; text-align: center; font-weight: 500;">
            </div>

            <div class="modal-buttons" style="margin-top: 16px;">
                <button class="btn-modal-secondary" onclick="closeTaskModal()">Cancel</button>
                <button class="btn-modal-primary" onclick="saveTaskFromModal()">Save Task</button>
            </div>
        </div>
    </div>


    <script type="module" src="src/app.js"></script>
    <script>
        // --- STATE ---
        const APP_STORAGE_KEY = 'adl_checklist_data';

        // --- DATA STRUCTURE ---
        const DEFAULT_DATA = {
            tasks: [], // Converted to Array
            recurring: [],
            // collapsed: { morning: false, afternoon: [], evening: false }, // Removed
            history: {},
            lastActiveDate: null,
            stats: { currentStreak: 0, bestStreak: 0 }
        };

        // Initialize Global State
        window.appData = {};
        // Legacy alias if needed, but window.appData covers it.
        var appData = window.appData;

        // Listener for Sleep Tracker updates
        window.addEventListener('sleep-updated', () => {
            if (typeof updateTimeStats === 'function') updateTimeStats();
            // Also update overview if needed for other stats
            if (typeof updateOverview === 'function') updateOverview();
        });


        // --- SUPABASE & AUTH (Legacy Handled by Module) ---
        // window.supabase and window.currentUser are populated by src/app.js
        let isLoginMode = true; // Kept for legacy UI function
        let appInitialized = false;

        // Legacy toggle support (will be overwritten by module if cleaner, but kept for safety)
        // Actually, src/app.js exposes toggleAuthMode to window, so we can remove this if module loads fast enough.
        // But for safety, let's remove the inline definition and let the module handle it.

        async function doLogout() {
            if (window.doLogout) await window.doLogout();
            else window.location.reload();
        }

        // Legacy code removed


        function hideApp() {
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                el.style.display = 'none';
            });
            // Also hide sidebar on mobile if open
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('overlay').classList.remove('show');
        }

        function showApp() {
            document.getElementById('auth-modal').style.display = 'none';
            const appView = document.getElementById('app-view');
            if (appView) appView.classList.remove('hidden');
            const mobileNav = document.getElementById('global-mobile-nav');
            if (mobileNav) mobileNav.classList.remove('hidden');
            document.getElementById('view-today').style.display = 'block';
            initApp();
        }


        async function handleAuth() {
            if (!supabase) {
                document.getElementById('auth-error').innerText = "Supabase not connected. Refresh?";
                return;
            }
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const errDiv = document.getElementById('auth-error');
            errDiv.innerText = "";

            if (!email || !pass) {
                errDiv.innerText = "Please enter email and password";
                return;
            }

            const btn = document.getElementById('auth-submit-btn');
            btn.innerText = "Loading...";
            btn.disabled = true;

            try {
                if (isLoginMode) {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: pass
                    });
                    if (error) throw error;
                    currentUser = data.user;
                    showApp();
                } else {
                    const { data, error } = await supabase.auth.signUp({
                        email: email,
                        password: pass
                    });
                    if (error) throw error;
                    alert("Account created! You can now sign in.");
                    toggleAuthMode(); // Switch to login
                }
            } catch (err) {
                errDiv.innerText = err.message;
            } finally {
                if (currentUser) {
                    // Populate Profile
                    const pEmail = document.getElementById('profile-email');
                    if (pEmail) pEmail.textContent = currentUser.email;
                    const pSec = document.getElementById('profile-section');
                    if (pSec) pSec.style.display = 'flex';

                    // Update profile photo if available
                    updateProfilePhoto();
                }

                btn.disabled = false;
                btn.innerText = isLoginMode ? "Sign In" : "Sign Up";
            }
        }

        async function loginWithGoogle() {
            try {
                if (!supabase) throw new Error("Supabase not connected");
                const { error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin + window.location.pathname
                    }
                });
                if (error) throw error;
            } catch (e) {
                alert("Google Login Error: " + e.message);
            }
        }
        // Expose to window for HTML onclick handlers
        window.loginWithGoogle = loginWithGoogle;

        function showForgotPasswordModal() {
            document.getElementById('auth-modal').style.display = 'none';
            const modal = document.getElementById('forgot-password-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.style.opacity = '1', 10);
            // Clear previous messages
            document.getElementById('reset-error').innerText = '';
            document.getElementById('reset-success').innerText = '';
            document.getElementById('reset-email').value = document.getElementById('auth-email').value || '';
        }

        function closeForgotPasswordModal() {
            const modal = document.getElementById('forgot-password-modal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('auth-modal').style.display = 'flex';
                document.getElementById('auth-modal').style.opacity = '1';
            }, 300);
        }

        async function sendPasswordResetEmail() {
            const email = document.getElementById('reset-email').value.trim();
            const errDiv = document.getElementById('reset-error');
            const successDiv = document.getElementById('reset-success');
            const btn = document.getElementById('reset-submit-btn');

            errDiv.innerText = '';
            successDiv.innerText = '';

            if (!email) {
                errDiv.innerText = 'Please enter your email address.';
                return;
            }

            if (!supabase) {
                errDiv.innerText = 'Database not connected. Try refreshing.';
                return;
            }

            btn.innerText = 'Sending...';
            btn.disabled = true;

            try {
                const { error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + '?reset=true'
                });
                if (error) throw error;
                successDiv.innerText = 'Reset link sent! Check your email (including spam folder).';
                btn.innerText = 'Link Sent!';
            } catch (e) {
                errDiv.innerText = e.message || 'Failed to send reset email.';
                btn.innerText = 'Send Reset Link';
                btn.disabled = false;
            }
        }

        function openAccountModal() {
            const m = document.getElementById('account-modal');
            const emailDisplay = document.getElementById('acc-email-display');
            if (currentUser && currentUser.email) {
                emailDisplay.textContent = currentUser.email;
            } else {
                emailDisplay.textContent = "Guest";
            }
            // Update profile photo
            updateProfilePhoto();
            // Load username
            loadUsername();
            m.style.display = 'flex';
            setTimeout(() => m.style.opacity = '1', 10);
        }

        function closeAccountModal() {
            const m = document.getElementById('account-modal');
            m.style.opacity = '0';
            setTimeout(() => m.style.display = 'none', 300);
        }

        function updateProfilePhoto() {
            if (!currentUser) return;

            // Check for Google profile photo
            const avatarUrl = currentUser.user_metadata?.avatar_url || currentUser.user_metadata?.picture;

            // Update modal photo
            const photoImg = document.getElementById('profile-photo');
            const fallback = document.getElementById('profile-fallback');

            if (avatarUrl && photoImg && fallback) {
                photoImg.src = avatarUrl;
                photoImg.style.display = 'block';
                fallback.style.display = 'none';
            } else if (photoImg && fallback) {
                photoImg.style.display = 'none';
                fallback.style.display = 'block';
            }

            // Update sidebar photo
            const sidebarImg = document.getElementById('sidebar-photo');
            const sidebarFallback = document.getElementById('sidebar-fallback');

            if (avatarUrl && sidebarImg && sidebarFallback) {
                sidebarImg.src = avatarUrl;
                sidebarImg.style.display = 'block';
                sidebarFallback.style.display = 'none';
            } else if (sidebarImg && sidebarFallback) {
                sidebarImg.style.display = 'none';
                sidebarFallback.style.display = 'block';
            }

            // Update mobile header photo
            const mobileImg = document.getElementById('mobile-photo');
            const mobileFallback = document.getElementById('mobile-fallback');

            if (avatarUrl && mobileImg && mobileFallback) {
                mobileImg.src = avatarUrl;
                mobileImg.style.display = 'block';
                mobileFallback.style.display = 'none';
            } else if (mobileImg && mobileFallback) {
                mobileImg.style.display = 'none';
                mobileFallback.style.display = 'block';
            }
        }

        async function toggleUsernameEdit() {
            const displaySpan = document.getElementById('acc-username-display');
            const inputField = document.getElementById('acc-username-input');
            const editBtn = document.getElementById('acc-username-edit-btn');

            if (!displaySpan || !inputField || !editBtn) return;

            // Currently in display mode, switch to edit mode
            if (displaySpan.style.display !== 'none') {
                inputField.value = displaySpan.textContent || '';
                displaySpan.style.display = 'none';
                inputField.style.display = 'block';
                inputField.focus();
                editBtn.textContent = ''; // Save icon
            }
            // Currently in edit mode, save and switch to display mode
            else {
                const newUsername = inputField.value.trim();

                if (!newUsername) {
                    alert('Username cannot be empty');
                    return;
                }

                // Save to Supabase profiles table
                try {
                    if (supabase && currentUser) {
                        const { error } = await supabase
                            .from('profiles')
                            .upsert({
                                id: currentUser.id,
                                username: newUsername,
                                updated_at: new Date().toISOString()
                            });

                        if (error) throw error;

                        // Update modal display
                        displaySpan.textContent = newUsername;
                        displaySpan.style.display = 'block';
                        inputField.style.display = 'none';
                        editBtn.textContent = ''; // Edit icon

                        // Update sidebar username
                        const sidebarUsername = document.getElementById('sidebar-username');
                        if (sidebarUsername) {
                            sidebarUsername.textContent = newUsername;
                        }

                        // Update mobile header username
                        const mobileUsername = document.getElementById('mobile-username');
                        if (mobileUsername) {
                            mobileUsername.textContent = newUsername;
                        }
                    }
                } catch (err) {
                    console.error('Username save error:', err);
                    alert('Failed to save username: ' + err.message);
                }
            }
        }

        async function loadUsername() {
            if (!currentUser || !supabase) return;

            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('username')
                    .eq('id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') throw error; // PGRST116 = no rows

                const username = data?.username || currentUser.email?.split('@')[0] || 'User';

                // Update modal username
                const displaySpan = document.getElementById('acc-username-display');
                if (displaySpan) {
                    displaySpan.textContent = username;
                }

                // Update sidebar username
                const sidebarUsername = document.getElementById('sidebar-username');
                if (sidebarUsername) {
                    sidebarUsername.textContent = username;
                }

                // Update mobile header username
                const mobileUsername = document.getElementById('mobile-username');
                if (mobileUsername) {
                    mobileUsername.textContent = username;
                }
            } catch (err) {
                console.error('Load username error:', err);
                // Fallback to email username
                const username = currentUser.email?.split('@')[0] || 'User';

                const displaySpan = document.getElementById('acc-username-display');
                if (displaySpan) {
                    displaySpan.textContent = username;
                }

                const sidebarUsername = document.getElementById('sidebar-username');
                if (sidebarUsername) {
                    sidebarUsername.textContent = username;
                }

                const mobileUsername = document.getElementById('mobile-username');
                if (mobileUsername) {
                    mobileUsername.textContent = username;
                }
            }
        }

        async function doLogout() {
            if (supabase) await supabase.auth.signOut();
            localStorage.clear(); // Ensure local data is gone so Auth Modal appears
            window.location.reload();
        }

        // --- CALENDAR FUNCTIONS ---
        let currentCalendarYear = new Date().getFullYear();
        let currentCalendarMonth = new Date().getMonth();
        let currentViewDate = new Date(); // New: Full date object for precision (week view)
        let currentCalendarView = 'month'; // New: 'week', 'month', 'year'
        let selectedDate = null;

        function renderCalendar(year, month) {
            const grid = document.getElementById('calendar-grid');
            const header = document.getElementById('calendar-month-year');
            const dayHeaders = document.querySelector('.calendar-day-headers');

            if (!grid || !header) return;

            // Reset grid style
            grid.innerHTML = '';
            grid.className = 'calendar-grid';
            grid.style.display = 'grid'; // Ensure grid display

            // Show day headers ONLY for month view
            if (dayHeaders) dayHeaders.style.display = (currentCalendarView === 'month') ? 'grid' : 'none';

            if (currentCalendarView === 'week') {
                renderWeekView(grid, header);
            } else if (currentCalendarView === 'year') {
                renderYearView(grid, header);
            } else {
                renderMonthView(grid, header, year, month);
            }
        }

        function renderMonthView(grid, header, year, month) {
            // Restore Month Grid Layout
            grid.style.gridTemplateColumns = 'repeat(7, 1fr)';
            grid.style.gap = '4px';
            grid.style.padding = '4px';
            grid.style.borderTop = '1px solid #e5e7eb'; // Add top border
            grid.style.borderTopLeftRadius = '0px'; // No radius for month view as it attaches to headers
            grid.style.borderTopRightRadius = '0px';

            if (!grid || !header) return;

            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            header.textContent = `${monthNames[month]} ${year}`;

            // Clear grid
            grid.innerHTML = '';

            // Get first day of month and total days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            // Add previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const cell = createDayCell(day, year, month - 1, true);
                grid.appendChild(cell);
            }

            // Add current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = createDayCell(day, year, month, false);
                grid.appendChild(cell);
            }

            // Add next month days to fill grid (6 weeks = 42 cells)
            const totalCells = grid.children.length;
            const remainingCells = 42 - totalCells;
            for (let day = 1; day <= remainingCells; day++) {
                const cell = createDayCell(day, year, month + 1, true);
                grid.appendChild(cell);
            }
        }

        function renderWeekView(grid, header) {
            // Week View Grid: Vertical List (1 col)
            grid.style.gridTemplateColumns = '1fr';
            grid.style.gap = '12px';
            grid.style.padding = '4px 4px 4px 4px';
            grid.style.borderTop = '1px solid #e5e7eb'; // Add top border
            grid.style.borderTopLeftRadius = '8px'; // Add radius
            grid.style.borderTopRightRadius = '8px';

            // Calculate start of week (Sunday) based on currentViewDate
            const date = new Date(currentViewDate);
            const day = date.getDay(); // 0 is Sunday
            const diff = date.getDate() - day; // Adjust to Sunday
            const weekStart = new Date(date);
            weekStart.setDate(diff);

            // Set Header: Dec 14 - Dec 20, 2025
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);

            const options = { month: 'short', day: 'numeric' };
            header.textContent = `${weekStart.toLocaleDateString('en-US', options)} - ${weekEnd.toLocaleDateString('en-US', options)}, ${weekEnd.getFullYear()}`;

            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

            // Render 7 days
            for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                const cell = createDayCell(d.getDate(), d.getFullYear(), d.getMonth(), false);

                // Adjust cell style for Row layout
                cell.style.minHeight = '80px';

                // Inject Day Name into the Date Row (Header of the cell)
                const dateRow = cell.firstChild; // createDayCell puts dateRow first
                if (dateRow) {
                    dateRow.style.justifyContent = 'space-between';
                    dateRow.style.alignItems = 'center';

                    const dayNameSpan = document.createElement('span');
                    dayNameSpan.textContent = dayNames[i];
                    dayNameSpan.style.fontWeight = 'bold';
                    dayNameSpan.style.fontSize = '14px';
                    dayNameSpan.style.textTransform = 'uppercase';
                    dayNameSpan.style.color = 'var(--primary)'; // User request: Primary color

                    // Prepend to put it on the left
                    dateRow.insertBefore(dayNameSpan, dateRow.firstChild);
                }

                grid.appendChild(cell);
            }
        }

        function renderYearView(grid, header) {
            grid.classList.add('year-grid'); // Use CSS for responsive columns
            // grid.style.gridTemplateColumns = 'repeat(2, 1fr)'; // Moved to CSS
            grid.style.gap = '16px';
            grid.style.padding = '16px';
            grid.style.borderTop = '1px solid #e5e7eb'; // Add top border
            grid.style.borderTopLeftRadius = '8px'; // Add radius
            grid.style.borderTopRightRadius = '8px';

            header.textContent = `${currentViewDate.getFullYear()}`;

            const year = currentViewDate.getFullYear();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];

            for (let m = 0; m < 12; m++) {
                // Mini Calendar Container
                const miniCal = document.createElement('div');
                miniCal.className = 'mini-calendar';
                miniCal.style.border = '1px solid #e5e7eb';
                miniCal.style.borderRadius = '8px';
                miniCal.style.padding = '8px';
                miniCal.style.background = '#f9fafb';

                // Month Title
                const title = document.createElement('h4');
                title.textContent = monthNames[m];
                title.style.textAlign = 'center';
                title.style.color = 'var(--primary)';
                title.style.margin = '0 0 8px 0';
                title.style.fontSize = '14px';
                miniCal.appendChild(title);

                // Mini Grid
                const miniGrid = document.createElement('div');
                miniGrid.style.display = 'grid';
                miniGrid.style.gridTemplateColumns = 'repeat(7, 1fr)';
                miniGrid.style.gap = '2px';
                miniGrid.style.fontSize = '10px';
                miniGrid.style.textAlign = 'center';

                // Mini Headers (S M T W T F S)
                ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(d => {
                    const h = document.createElement('div');
                    h.textContent = d;
                    h.style.fontWeight = 'bold';
                    h.style.color = '#6b7280';
                    miniGrid.appendChild(h);
                });

                // Days
                const firstDay = new Date(year, m, 1).getDay();
                const daysInMonth = new Date(year, m + 1, 0).getDate();

                // Empty slots
                for (let i = 0; i < firstDay; i++) {
                    miniGrid.appendChild(document.createElement('div'));
                }

                // Days
                for (let d = 1; d <= daysInMonth; d++) {
                    const dayCell = document.createElement('div');
                    dayCell.textContent = d;
                    dayCell.style.padding = '2px';
                    dayCell.style.cursor = 'pointer';
                    // Highlight numbers if needed or click to month
                    dayCell.onclick = () => {
                        currentCalendarMonth = m;
                        // If clicking a day, maybe go to day view? Or just month view
                        currentCalendarView = 'month';
                        currentViewDate.setMonth(m);
                        currentViewDate.setDate(d);
                        switchCalendarView('month');
                    };

                    // Highlight Today
                    const today = new Date();
                    if (d === today.getDate() && m === today.getMonth() && year === today.getFullYear()) {
                        dayCell.style.background = 'var(--primary)';
                        dayCell.style.color = 'white';
                        dayCell.style.borderRadius = '50%';
                        dayCell.style.width = '18px';
                        dayCell.style.height = '18px';
                        dayCell.style.margin = '0 auto';
                        dayCell.style.display = 'flex';
                        dayCell.style.alignItems = 'center';
                        dayCell.style.justifyContent = 'center';
                    }

                    miniGrid.appendChild(dayCell);
                }

                miniCal.appendChild(miniGrid);
                grid.appendChild(miniCal);
            }
        }

        function createDayCell(day, year, month, isOtherMonth) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day';
            cell.style.cssText = `
                border-radius: 5px;
                padding: 6px;
                cursor: pointer;
                position: relative;
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                font-size: 14px;
                background: #EEEEEE;
                transition: background 0.2s;
                min-height: 100px; /* Default for Month View */
            `;

            if (isOtherMonth) {
                cell.style.color = '#9ca3af';
                cell.style.background = '#f9fafb';
            } else {
                cell.style.color = '#374151';
            }

            // Click Handler: Open Choice Popup
            cell.onclick = (e) => {
                // Prevent bubbling if clicking a task bar inside
                if (e.target.closest('.event-bar')) return;

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                openDayActionPopup(dateStr);
            };

            // Check if today
            const today = new Date();
            const isToday = day === today.getDate() && month === today.getMonth() &&
                year === today.getFullYear() && !isOtherMonth;

            // Date Number - Top Right positioning
            const dateRow = document.createElement('div');
            dateRow.style.cssText = `
                display: flex;
                justify-content: flex-end;
                margin-bottom: 4px;
            `;

            const dateSpan = document.createElement('span');
            dateSpan.textContent = day;
            dateSpan.style.cssText = `
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                font-weight: 500;
            `;

            if (isToday) {
                dateSpan.style.background = 'var(--primary)'; // Blue highlight for today
                dateSpan.style.color = 'white';
            }

            dateRow.appendChild(dateSpan);
            cell.appendChild(dateRow);

            // Render Tasks as Bars
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const tasks = getTasksForDate(dateStr);

            if (tasks && tasks.length > 0) {
                const tasksContainer = document.createElement('div');
                tasksContainer.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    gap: 4px;
                    width: 100%;
                    overflow: hidden; /* Hide overflow */
                `;

                tasksContainer.classList.add('day-tasks-container');

                // Determine View Mode
                const isMonthView = typeof currentCalendarView === 'undefined' || currentCalendarView === 'month';
                const isWeekView = typeof currentCalendarView !== 'undefined' && currentCalendarView === 'week' && !isOtherMonth;

                // Month View Mobile Class
                if (isMonthView) {
                    tasksContainer.classList.add('month-view-tasks');
                }

                // Week View Layout Override
                if (isWeekView) {
                    tasksContainer.style.flexDirection = 'row';
                    tasksContainer.style.flexWrap = 'wrap';
                    tasksContainer.style.gap = '8px';
                    tasksContainer.style.alignContent = 'flex-start';
                }

                // Filtering for Month View Limit
                let tasksToRender = tasks;
                let remainingCount = 0;

                if (isMonthView && tasks.length > 2) {
                    tasksToRender = tasks.slice(0, 2);
                    remainingCount = tasks.length - 2;
                }

                tasksToRender.forEach(t => {
                    const taskDiv = document.createElement('div');
                    taskDiv.classList.add('day-task-item'); // Main class

                    // Set CSS Variables for dynamic colors
                    taskDiv.style.setProperty('--task-bg', t.color || '#e0f2fe');
                    taskDiv.style.setProperty('--task-text', t.textColor || '#0369a1');
                    taskDiv.style.setProperty('--task-border', t.borderColor || '#0284c7');

                    // Week View Style Override
                    if (isWeekView) {
                        taskDiv.style.width = 'calc(50% - 4px)';
                        taskDiv.style.height = 'auto';
                        taskDiv.style.minHeight = '32px';
                        taskDiv.style.whiteSpace = 'normal';
                        taskDiv.style.display = 'flex';
                        taskDiv.style.flexDirection = 'column';
                        taskDiv.style.justifyContent = 'flex-start';
                        taskDiv.style.padding = '4px';

                        // Week view: show title and time
                        const titleText = t.title || t.text || 'Untitled';
                        let contentHTML = `<span style="font-weight:600;">${titleText}</span>`;
                        if (t.startTime) {
                            contentHTML += `<div style="font-size: 10px; opacity: 0.8; margin-top: 1px;">${t.startTime}</div>`;
                        }
                        taskDiv.innerHTML = contentHTML;
                    } else {
                        // Month view: just title
                        taskDiv.textContent = t.title || t.text || 'Untitled';
                    }

                    taskDiv.addEventListener('click', () => openViewTaskModal(t.id));
                    tasksContainer.appendChild(taskDiv);
                });

                // "+X more" Label for Month View
                if (isMonthView && remainingCount > 0) {
                    const moreLabel = document.createElement('div');
                    moreLabel.textContent = `+ ${remainingCount} more`;
                    moreLabel.style.cssText = `
                        font-size: 10px;
                        color: #6b7280;
                        padding-left: 4px;
                        font-weight: 500;
                    `;
                    tasksContainer.appendChild(moreLabel);
                }

                cell.appendChild(tasksContainer);
            }

            // Hover effect
            cell.onmouseenter = () => {
                if (!isOtherMonth) cell.style.background = '#DFDFDF';
            };
            cell.onmouseleave = () => {
                if (!isOtherMonth) cell.style.background = '#EEEEEE';
            };

            cell.onclick = () => openDayPopup(year, month, day);

            return cell;
        }

        function hasTasksOnDate(dateStr) {
            if (!appData || !appData.history) return false;
            const dayData = appData.history[dateStr];
            return dayData && dayData.tasks && dayData.tasks.length > 0;
        }

        function navigateCalendar(direction) {
            if (currentCalendarView === 'month') {
                currentCalendarMonth += direction;
                if (currentCalendarMonth > 11) {
                    currentCalendarMonth = 0;
                    currentCalendarYear++;
                } else if (currentCalendarMonth < 0) {
                    currentCalendarMonth = 11;
                    currentCalendarYear--;
                }
                // Sync view date
                currentViewDate.setFullYear(currentCalendarYear);
                currentViewDate.setMonth(currentCalendarMonth);
            } else if (currentCalendarView === 'week') {
                // Shift by 7 days
                currentViewDate.setDate(currentViewDate.getDate() + (direction * 7));
                // Sync legacy vars
                currentCalendarMonth = currentViewDate.getMonth();
                currentCalendarYear = currentViewDate.getFullYear();
            } else if (currentCalendarView === 'year') {
                currentCalendarYear += direction;
                // Sync view date
                currentViewDate.setFullYear(currentCalendarYear);
            }
            renderCalendar(currentCalendarYear, currentCalendarMonth);
        }

        function switchCalendarView(view) {
            currentCalendarView = view;

            // Update buttons
            document.querySelectorAll('.view-toggle-group button').forEach(btn => {
                const btnView = btn.textContent.trim().toLowerCase();
                if (btnView === view) {
                    btn.style.background = '#f3f4f6';
                    btn.style.color = 'var(--primary)';
                    btn.style.fontWeight = '600';
                } else {
                    btn.style.background = 'white';
                    btn.style.color = 'var(--text-light)';
                    btn.style.fontWeight = '500';
                }
            });

            renderCalendar(currentCalendarYear, currentCalendarMonth);
        }

        function openDayPopup(year, month, day) {
            selectedDate = { year, month, day };
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const date = new Date(year, month, day);
            const dayName = dayNames[date.getDay()];

            document.getElementById('day-popup-date').textContent =
                `${dayName}, ${monthNames[month]} ${day}, ${year} `;

            // Get tasks for this date
            const tasks = getTasksForDate(dateStr);
            const tasksList = document.getElementById('day-tasks-list');
            const emptyMsg = document.getElementById('day-popup-empty');

            if (tasks && tasks.length > 0) {
                tasksList.innerHTML = tasks.map(task => `
                    <div onclick="openViewTaskModal('${task.id}')" style="padding: 12px; background: #f9fafb; border-radius: 8px; border-left: 3px solid var(--primary); cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='#f9fafb'">
                        <div style="font-weight: 600; margin-bottom: 4px; color: var(--text-dark);">${task.title || task.text || 'Untitled Task'}</div>
                        <div style="font-size: 0.85rem; color: var(--text-light); display: flex; align-items: center; gap: 6px;">
                            <span>${task.startTime && task.endTime ? `${task.startTime} - ${task.endTime}` : 'All Day'}</span>
                            ${task.location ? `<span style="font-size: 0.8em;"></span>` : ''}
                        </div>
                    </div>
                `).join('');
                tasksList.style.display = 'flex';
                emptyMsg.style.display = 'none';
            } else {
                tasksList.style.display = 'none';
                emptyMsg.style.display = 'block';
            }

            // Show modal
            const modal = document.getElementById('day-popup-modal');
            const footer = modal.querySelector('.day-popup-footer');

            // Check if past date
            const todayStr = getTodayStr();
            if (dateStr < todayStr) {
                if (footer) footer.style.display = 'none';
            } else {
                if (footer) footer.style.display = 'flex';
            }

            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function getTasksForDate(dateStr) {
            if (!appData || !appData.tasks) return [];

            // Helpful helper usually needed for day of week etc.
            const dateObj = new Date(dateStr);
            // Fix timezone offset for day calculation if needed, but assuming yyyy-mm-dd is strictly local
            // Better: Parse standard
            const [y, m, d] = dateStr.split('-').map(Number);
            const checkDate = new Date(y, m - 1, d);
            const dayOfWeekMap = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayName = dayOfWeekMap[checkDate.getDay()];

            return appData.tasks.filter(task => {
                // 1. Exact Date Match (One-time task or event)
                if (task.date === dateStr) return true;

                // 2. Recurring Task Match
                if (task.recur && task.recurDays) {
                    return task.recurDays.includes(dayName);
                }

                return false;
            });
        }

        function closeDayPopup() {
            const modal = document.getElementById('day-popup-modal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        function addTaskFromCalendar() {
            closeDayPopup();
            if (selectedDate) {
                const dateStr = `${selectedDate.year}-${String(selectedDate.month + 1).padStart(2, '0')}-${String(selectedDate.day).padStart(2, '0')}`;
                openTaskModal(null, dateStr, 'task'); // Open modal with pre-filled date as TASK
            }
        }

        function addEventFromCalendar() {
            closeDayPopup();
            if (selectedDate) {
                const dateStr = `${selectedDate.year}-${String(selectedDate.month + 1).padStart(2, '0')}-${String(selectedDate.day).padStart(2, '0')}`;
                openTaskModal(null, dateStr, 'event'); // Open modal with pre-filled date as EVENT
            }
        }

        // --- INIT ---
        function init() {
            initApp();
        }



        // --- ASYNC DATA LAYER ---

        async function initApp() {
            // Load from Supabase OR LocalStorage
            // if (!currentUser) return; // REMOVED to allow local load
            if (appInitialized) return; // Prevent double init
            appInitialized = true;

            toggleLoading(true); // Helper optional
            await loadData();
            toggleLoading(false);

            // Clock
            updateClock();
            setInterval(updateClock, 1000);

            // Reminders
            if ("Notification" in window) {
                Notification.requestPermission();
            }
            setInterval(checkReminders, 30000);

            // Minute updates
            setInterval(renderTasks, 60000);
            setInterval(updateProgress, 60000);
            setInterval(updateCurrentTimeProgress, 60000); // Update current time indicator
        }

        async function loadData() {
            // 0. Initialize Defaults
            appData = JSON.parse(JSON.stringify(DEFAULT_DATA));

            // FALLBACK: Load from LocalStorage first (Critical for Offline/Non-Auth use)
            const local = localStorage.getItem(APP_STORAGE_KEY);
            if (local) {
                try {
                    const parsed = JSON.parse(local);
                    // Merge logic: prefer parsed tasks if valid
                    if (parsed.tasks && Array.isArray(parsed.tasks)) {
                        appData.tasks = parsed.tasks;
                    }
                    if (parsed.stats) appData.stats = { ...appData.stats, ...parsed.stats };

                    // Restore Meds (New Feature)
                    if (parsed.meds && Array.isArray(parsed.meds)) {
                        appData.meds = parsed.meds;
                    }
                } catch (e) { console.error("Local load error", e); }
            }

            initMeds(); // Ensure structure exists

            if (!currentUser) {
                // Stop here if no user, render local data
                setupDateDisplay();
                renderTasks();
                renderStreak();
                updateProgress();
                updateOverview();
                return;
            }

            // 1. Fetch Tasks (Legacy direct call for now, as taskService.fetchTasks wasn't requested strictly, but good to have)
            // User requested: "Move database functions... Move all logic related to creating/completing standard tasks".
            // Fetching tasks is "loading", not "creating/completing". I will leave task fetching as is to minimize risk, 
            // OR I can add fetchTasks to taskService. 
            // Let's stick to the EXPLICIT request: "Move addMedication(), fetchMedications(), and takeMedication()".
            // So I MUST refactor Meds fetching.

            const { data: tasks, error } = await supabase
                .from('tasks')
                .select('*')
                .eq('user_id', currentUser.id);

            if (error) {
                console.error("Error loading tasks:", error);
            }

            // 1b. Fetch Medications via Service
            if (window.services && window.services.medication) {
                const meds = await window.services.medication.fetchMedications(currentUser.id);
                if (meds && meds.length > 0) {
                    appData.meds = meds;
                }
            }

            // 1c. Fetch Today's Sleep Log (Fix for Stats Reset)
            const todayStr = new Date().toISOString().split('T')[0];
            const { data: sleepData, error: sleepError } = await supabase
                .from('sleep_logs')
                .select('duration_minutes')
                .eq('user_id', currentUser.id)
                .eq('log_date', todayStr)
                .order('created_at', { ascending: false })
                .limit(1)
                .single();

            if (sleepData) {
                if (!appData.sleep) appData.sleep = {};
                appData.sleep.durationMinutes = sleepData.duration_minutes;
            }

            // Map DB structure (snake_case) to App structure (camelCase)

            // Map DB structure (snake_case) to App structure (camelCase)
            // Map DB structure (snake_case) to App structure (camelCase)
            // AND Split into Tasks and Recurring Templates
            // AND Split into Tasks and Recurring Templates
            const remoteItems = (tasks || []).map(t => ({
                id: t.id,
                title: t.title || t.text || "(No Title)", // Handle legacy 'text' field
                date: t.date, // YYYY-MM-DD
                startTime: t.start_time,
                endTime: t.end_time,
                endsNextDay: t.ends_next_day, // Snake to Camel
                note: t.note,
                color: t.color, // Preserved
                // Default styles if missing
                borderColor: t.color || '#0284c7',
                textColor: '#0369a1',
                checked: t.status === 'completed' || t.checked,
                isRecurring: !!t.recur_days,
                recurDays: t.recur_days || [],
                recurTime: t.reminders ? t.reminders[0] : null,
                type: t.recur_days ? 'template' : 'task'
            }));

            const remoteTasks = remoteItems.filter(i => i.type === 'task');
            const remoteTemplates = remoteItems.filter(i => i.type === 'template');

            // MERGE: Combine Local + Remote
            // This ensures that if a task was saved locally but failed tosync to DB, it is not lost on refresh.
            const taskMap = new Map();

            // 1. Add Local Tasks
            if (appData.tasks) {
                appData.tasks.forEach(t => taskMap.set(t.id, t));
            }

            // 2. Add/Overwrite with Remote Tasks (Server is Truth)
            remoteTasks.forEach(t => taskMap.set(t.id, t));

            appData.tasks = Array.from(taskMap.values());
            appData.taskTemplates = remoteTemplates;

            // --- DEDUPLICATION FIX ---
            // Remove tasks with identical ID or identical (Date + Title + StartTime)
            const uniqueTasks = [];
            const seenIds = new Set();
            const seenContent = new Set();

            appData.tasks.forEach(t => {
                const contentKey = `${t.date}-${t.text || t.title}-${t.startTime}`;

                if (seenIds.has(t.id)) return; // Duplicate ID
                if (seenContent.has(contentKey)) return; // Duplicate Content

                seenIds.add(t.id);
                seenContent.add(contentKey);
                uniqueTasks.push(t);
            });

            if (uniqueTasks.length < appData.tasks.length) {
                console.log(`Cleaned up ${appData.tasks.length - uniqueTasks.length} duplicate tasks.`);
                appData.tasks = uniqueTasks;
            }
            // -------------------------

            // 2. Fetch Profile (Streak)
            const { data: profile } = await supabase
                .from('profiles')
                .select('streak, last_active')
                .eq('id', currentUser.id)
                .single();

            if (profile) {
                appData.stats.streak = profile.streak || 0;
                appData.stats.lastActive = profile.last_active;
            }

            setupDateDisplay();
            await checkDateRollover();
            renderTasks();
            renderStreak();
            updateProgress();
            updateOverview();
        }

        async function saveData() {
            // ALWAYS save to LocalStorage as backup/primary for non-auth
            localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(appData));

            // Sync to Supabase if logged in (Optimistic UI already updated appData)
            // Note: This function is often called after individual CRUD ops which handle their own DB calls.
            // But we keep this for general state persistence.

            updateOverview(); // still update stats UI locally
            updateProgress(); // Update progress bar and details on data change
        }
        window.saveData = saveData;

        // --- CRUD Overrides ---

        // (Duplicate saveTaskFromModal removed)


        // Helper to update specific fields
        async function patchTask(id, fields) {
            const idx = appData.tasks.findIndex(t => t.id === id);
            if (idx > -1) {
                appData.tasks[idx] = { ...appData.tasks[idx], ...fields };
                renderTasks();
                updateProgress();
            }

            if (supabase) await supabase.from('tasks').update(fields).eq('id', id);
        }

        async function deleteTask(id) {
            // If recurring, we might need logic. For now delete ID.
            triggerGlobalAction('close');
            openDeleteModal(id); // Using the safety modal from Phase 16
        }

        async function executeDelete() {
            if (!pendingDeleteId) return;

            // Optimistic
            appData.tasks = appData.tasks.filter(t => t.id !== pendingDeleteId);
            renderTasks();
            updateProgress();
            closeDeleteModal();

            // Async
            if (supabase) await supabase.from('tasks').delete().eq('id', pendingDeleteId);
            pendingDeleteId = null;
        }

        // --- UPDATED ACTIONS ---

        async function startTask(id) {
            await patchTask(id, { status: 'in_progress' });
        }

        async function executeConfirmEnd() {
            if (pendingConfirmId) {
                await patchTask(pendingConfirmId, { status: 'completed', checked: true });
                // Confetti
                // Update Streak logic??
                checkStreak();
            }
            closeConfirmModal();
        }

        async function toggleCheck(id) {
            // Basic toggle (though mostly handled by Start/End lifecycle now)
            // But if user manually clicks box?
            // The lifecycle prevents manual check unless finished/missed? 
            // Let's assume manual toggle is allowed for flexibility.
            const t = appData.tasks.find(x => x.id === id);
            if (t) {
                await patchTask(id, { checked: !t.checked });
                checkStreak();
            }
        }

        async function checkStreak() {
            const today = new Date().toLocaleDateString();
            // Simple Logic: if all tasks done? Or just 1 task?
            // Let's say if ANY task done today
            const anyDone = appData.tasks.some(t => t.checked);

            if (anyDone && appData.stats.lastActive !== today) {
                appData.stats.streak++;
                appData.stats.lastActive = today;

                // Sync Profile
                if (supabase) {
                    await supabase.from('profiles').upsert({
                        id: currentUser.id,
                        streak: appData.stats.streak,
                        last_active: today
                    });
                }
                renderStreak();
            }
        }

        // --- Helper: Loading ---
        function toggleLoading(show) {
            // Optional: spinner overlay
        }

        // --- DATA MANAGEMENT ---
        // function loadData() { // Original loadData is replaced by Supabase version
        //     const stored = localStorage.getItem(APP_STORAGE_KEY);
        //     if (stored) {
        //         const parsed = JSON.parse(stored);
        //         // V2 Migration for Recurring
        //         if (!parsed.recurring) parsed.recurring = [];
        //         // V3 Migration for tasks structure (object to array)
        //         if (parsed.tasks && !Array.isArray(parsed.tasks)) {
        //             const migratedTasks = [];
        //             if (parsed.tasks.morning) migratedTasks.push(...parsed.tasks.morning);
        //             if (parsed.tasks.afternoon) migratedTasks.push(...parsed.tasks.afternoon);
        //             if (parsed.tasks.evening) migratedTasks.push(...parsed.tasks.evening);
        //             parsed.tasks = migratedTasks;
        //         }
        //         // Remove collapsed property if it exists from old structure
        //         if (parsed.collapsed) delete parsed.collapsed;

        //         appData = parsed;
        //     } else {
        //         appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
        //     }

        //     setupDateDisplay();
        //     checkDateRollover();
        //     renderTasks();
        //     renderStreak();
        //     updateOverview(); // initial stats
        //     updateProgress(); // Initial call for progress bar and details
        // }

        // function saveData() { // Original saveData is replaced by Supabase version
        //     localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(appData));
        //     updateOverview();
        //     updateProgress(); // Update progress bar and details on data change
        // }

        // --- TODAY BUTTON LOGIC ---
        function updateTodayButton() {
            const now = new Date();
            const dateEl = document.getElementById('today-btn-date');
            if (dateEl) dateEl.textContent = now.getDate();
        }

        function resetToToday() {
            const now = new Date();
            currentCalendarYear = now.getFullYear();
            currentCalendarMonth = now.getMonth();
            currentViewDate = new Date(currentCalendarYear, currentCalendarMonth, 1);

            renderCalendar(currentCalendarYear, currentCalendarMonth);

            // If in Week view, we should probably jump to this week, but renderCalendar handles dispatch.
            // However, renderWeekView relies on currentWeekStart.
            // If we are in Week view, we must reset currentWeekStart to this week.
            if (typeof currentCalendarView !== 'undefined' && currentCalendarView === 'week') {
                // Logic to find start of this week
                const day = now.getDay();
                const diff = now.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is sunday
                // Simple reset:
                currentWeekStart = new Date(now);
                const currentDay = currentWeekStart.getDay();
                const distanceToMonday = currentDay === 0 ? 6 : currentDay - 1;
                currentWeekStart.setDate(currentWeekStart.getDate() - distanceToMonday);
                renderWeekView(currentWeekStart);
            }
        }

        // Initialize button date on load
        document.addEventListener('DOMContentLoaded', () => {
            updateTodayButton();
        });

        // --- DATE LOGIC ---
        function getTodayStr() {
            const d = new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function archiveHistory(dateToArchive) {
            const stats = calculateStats();
            if (!appData.history[dateToArchive]) {
                appData.history[dateToArchive] = { pct: stats.pct };
            }

            // Update streak based on the archived day's stats
            if (stats.pct < 100) {
                appData.stats.currentStreak = 0;
            } else {
                // If it was 100%, streak continues. This will be incremented on the *next* day's rollover
                // or when the user explicitly "finishes" the day.
                // For rollover, we just check if it was 100% to decide if streak *continues*.
                // The actual increment happens when the day is confirmed complete.
            }
        }

        async function checkDateRollover() {
            const today = getTodayStr();
            if (appData.lastActiveDate && appData.lastActiveDate !== today) {
                // New Day!
                archiveHistory(appData.lastActiveDate);

                // Reset daily list
                // 1. Clear tasks that are instances (checked or not)
                // 2. Clear checks on manual tasks?
                // Logic: "Reset Checks"
                // Re-populating recurring tasks...

                // Strategy: Clear "Recurring Instances", Keep "Manual One-Time" (maybe?)
                // User requirement: "Archive previous day... Reset tasks... Populate recurring"

                // For simplified "Single List":
                // 1. Wipe everything? Or just recurring?
                // appData.tasks is now a flat array.

                // Filter out old recurring instances
                // Keep manual tasks? Or wipe all? Usually ADL is daily.
                // Let's wipe all for fresh day, except maybe future ones?

                appData.tasks = []; // Clear all for new day

                appData.stats.currentStreak = (calculateStats().pct === 100) ?
                    (appData.stats.currentStreak) : 0;
                // Wait, logic flaw. Archive calculated stats BEFORE reset.
                // Fixed in archiveHistory call logic (it saves current state).

                await populateRecurringTasks(today);

                // Update Profile Last Active (DB) to prevent re-generation
                if (supabase) {
                    await supabase.from('profiles').upsert({
                        id: currentUser.id,
                        last_active: today,
                        streak: appData.stats.streak
                    });
                }
            }
            appData.lastActiveDate = today;
            saveData();
        }

        async function populateRecurringTasks(dateStr) {
            // Find templates matching today's day name
            const daysMap = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayName = daysMap[new Date(dateStr).getDay()];

            const instancesToInsert = [];

            appData.recurring.forEach(tmpl => {
                if (tmpl.days.includes(dayName)) {
                    // Create Local Instance (camelCase)
                    const instance = {
                        id: crypto.randomUUID(), // Unique ID
                        templateId: tmpl.id,
                        text: tmpl.text,
                        checked: false,
                        startTime: tmpl.startTime,
                        endTime: tmpl.endTime,
                        note: tmpl.note,
                        reminder: tmpl.reminder ? { ...tmpl.reminder, notified: false } : undefined,
                        status: 'pending',
                        date: dateStr,
                        user_id: currentUser.id
                    };
                    appData.tasks.push(instance);

                    // Create DB Payload (snake_case)
                    instancesToInsert.push({
                        id: instance.id,
                        user_id: currentUser.id,
                        template_id: tmpl.id,
                        title: tmpl.text, // MAP text -> title
                        start_time: tmpl.startTime,
                        end_time: tmpl.endTime,
                        date: dateStr,
                        status: 'pending',
                        checked: false,
                        note: tmpl.note,
                        reminder: instance.reminder
                    });
                }
            });

            // The provided snippet seems to be out of context or malformed.
            // Assuming the intent was to add a check before iterating over appData.tasks
            // in a different function, or if it was meant to be part of a different logic block.
            // As per the instruction, I'm inserting the provided code block as is,
            // but noting its likely incorrect placement and syntax within this context.
            // If this was intended for a different function (e.g., updateProgress or calculateStats),
            // please provide more specific placement instructions.
            // For now, placing it where the instruction implies, which is syntactically incorrect
            // if it's meant to be inside the object literal.
            // Given the instruction's format, it seems to imply insertion *after* the `end_time` property
            // but *before* the `date` property, which is not valid JS syntax for an object literal.
            // I will place it *after* the `instancesToInsert.push` block, before the batch insert,
            // as this is the only syntactically plausible interpretation of "before forEach"
            // if it refers to a new forEach loop, and not the existing one.
            // However, the snippet itself contains `appData.tasks.forEach`, so it's a new loop.
            // The variables `currentMins` and `remainingMins` are not defined here.
            // `timeToMins` is also not defined, `timeToMinutes` is.

            // Given the strict instruction to "make the change faithfully and without making any unrelated edits"
            // and "return the full contents of the new code document after the change",
            // I must insert the provided snippet exactly as given, even if it results in invalid syntax
            // or undefined variables in this specific context.
            // The instruction's "Code Edit" snippet shows it being inserted *between* object properties,
            // which is not valid. I will place it *after* the `instancesToInsert.push` block,
            // but before the `// Batch Insert to DB` comment, as this is the closest
            // to the provided context that maintains some semblance of structure,
            // although the snippet itself is still problematic in this function.

            // Re-reading the instruction: "Check if tasks exists before forEach"
            // The provided code snippet is:
            // `if (appData.tasks) { appData.tasks.forEach(t => { ... }); }`
            // This is a new block of code. The instruction's context shows it *inside* the `instancesToInsert.push` object.
            // This is the problematic part. I cannot insert an `if` statement inside an object literal.

            // Let's assume the user made a mistake in the context provided for the insertion point,
            // and the `if (appData.tasks)` block is meant to be a standalone block of code.
            // The instruction's context shows:
            // `end_time: tmpl.endTime,`
            // `if (appData.tasks) { ... }`
            // `// Batch Insert to DB`
            // This implies it should be *after* the `instancesToInsert.push` block, but before the `Batch Insert` comment.
            // This is the only way to make it syntactically valid as a standalone block.

            if (appData.tasks) {
                appData.tasks.forEach(t => {
                    if (t.time && !t.checked) {
                        const mins = timeToMins(t.time); // timeToMins is not defined in this scope, timeToMinutes is.
                        if (mins > currentMins) { // currentMins is not defined in this scope.
                            remainingMins += 15; // remainingMins is not defined in this scope.
                        }
                    }
                });
            }

            // Batch Insert to DB
            if (instancesToInsert.length > 0 && supabase) {
                const { error } = await supabase.from('tasks').insert(instancesToInsert);
                if (error) console.error("Error generating recurring instances:", error);
            }
        }

        function setupDateDisplay() {
            const now = new Date();
            document.getElementById('current-date-display').textContent = now.toLocaleDateString(undefined, { weekday: 'long' });
            document.getElementById('current-day-detail').textContent = now.toLocaleDateString(undefined, { month: 'long', day: 'numeric', year: 'numeric' });
            updateClock();
            setInterval(updateClock, 1000);
        }

        function updateClock() {
            const now = new Date();
            let hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';

            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'

            document.getElementById('clock-time').textContent = `${hours}:${minutes} `;
            document.getElementById('clock-ampm').textContent = ampm;
        }

        // --- CORE FEATURES ---
        // --- TASK MANAGMENT ---
        function toggleTask(id) {
            const task = appData.tasks.find(t => t.id === id);
            if (task) {
                task.checked = !task.checked;
                saveData();
                renderTasks(); // Full re-render to update progress and UI
                renderStreak();
                updateProgress(); // Update progress bar and details
            }
        }

        function populateTimeDropdowns() {
            const startSelect = document.getElementById('tm-start');
            const endSelect = document.getElementById('tm-end');

            if (!startSelect || !endSelect) return;

            // Generate 24-hour time options in 30-minute intervals
            const times = [];
            for (let h = 0; h < 24; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const hour = String(h).padStart(2, '0');
                    const min = String(m).padStart(2, '0');
                    times.push(`${hour}:${min} `);
                }
            }

            // Get allocated slots for current date
            const taskDate = document.getElementById('tm-date').value || getTodayStr();
            const currentTaskId = document.getElementById('tm-id').value;
            const allocatedSlots = getAllocatedTimeSlots(taskDate, currentTaskId);

            // Populate start time dropdown
            startSelect.innerHTML = '<option value="">-- Select Start --</option>';
            times.forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;

                // Check if this time is in an allocated slot
                const timeMinutes = timeToMinutes(time);
                const isAllocated = allocatedSlots.some(slot =>
                    timeMinutes >= slot.start && timeMinutes < slot.end
                );

                if (isAllocated) {
                    option.disabled = true;
                    option.textContent += ' (Allocated)';
                    option.style.color = '#ccc';
                }

                startSelect.appendChild(option);
            });

            // Populate end time dropdown
            endSelect.innerHTML = '<option value="">-- Select End --</option>';
            times.forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = time;

                // Check if this time is in an allocated slot
                const timeMinutes = timeToMinutes(time);
                const isAllocated = allocatedSlots.some(slot =>
                    timeMinutes > slot.start && timeMinutes <= slot.end
                );

                if (isAllocated) {
                    option.disabled = true;
                    option.textContent += ' (Allocated)';
                    option.style.color = '#ccc';
                }

                endSelect.appendChild(option);
            });
        }

        function getAllocatedTimeSlots(taskDate, excludeTaskId) {
            const allocatedSlots = [];

            // Get day name for recurring tasks
            const daysMap = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const taskDateObj = new Date(taskDate);
            const taskDayName = daysMap[taskDateObj.getDay()];

            appData.tasks.forEach(task => {
                // Skip the current task being edited
                if (excludeTaskId && task.id === excludeTaskId) return;

                // Check if task applies to this date
                let appliesToDate = false;

                if (task.date === taskDate) {
                    appliesToDate = true;
                } else if (task.recurDays && Array.isArray(task.recurDays) && task.recurDays.includes(taskDayName)) {
                    appliesToDate = true;
                }

                if (appliesToDate && task.startTime && task.endTime) {
                    allocatedSlots.push({
                        start: timeToMinutes(task.startTime),
                        end: timeToMinutes(task.endTime),
                        taskName: task.text
                    });
                }
            });

            return allocatedSlots;
        }

        function timeToMinutes(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        }

        function openTaskModal(id = null, date = null, mode = 'task') {
            // Close other menus
            triggerGlobalAction('close');

            const modal = document.getElementById('task-modal');
            const title = document.getElementById('tm-title');
            const headerDate = document.getElementById('tm-header-date');
            const locationGroup = document.getElementById('tm-location-group');

            // Helper to get element values
            const setVal = (eid, val) => document.getElementById(eid).value = val || '';
            const setCheck = (eid, val) => document.getElementById(eid).checked = !!val;

            document.getElementById('tm-id').value = id || '';

            // Handle Mode UI (Task vs Event)
            const dateGroup = document.getElementById('tm-date-group');
            const recurGroup = document.getElementById('tm-recur-group');

            if (mode === 'event') {
                title.textContent = id ? "Edit Event" : "Add Event";
                if (locationGroup) locationGroup.style.display = 'block';
                if (recurGroup) recurGroup.style.display = 'none'; // Hide Recur for Event
                if (dateGroup) dateGroup.style.display = 'none'; // Hide Date for Event too
                const nameLabel = document.getElementById('tm-name-label');
                if (nameLabel) nameLabel.textContent = "Event Name";
            } else {
                title.textContent = id ? "Edit Task" : "Add Task"; // Default Title
                if (locationGroup) locationGroup.style.display = 'none';
                if (recurGroup) recurGroup.style.display = 'flex'; // Show Recur for Task (Use Flex to keep alignment)
                if (dateGroup) dateGroup.style.display = 'none'; // Hide Date for Task (Requested)
                const nameLabel = document.getElementById('tm-name-label');
                if (nameLabel) nameLabel.textContent = "Task Name";
            }

            if (id) {
                // Editing
                const task = appData.tasks.find(t => t.id === id);
                if (!task) return;

                // Override Mode based on task type if we saved it (ToDo: Add type to task schema later)
                // For now, if it has a location, assume it's an event
                if (task.location) {
                    title.textContent = "Edit Event";
                    if (locationGroup) locationGroup.style.display = 'block';
                    if (recurGroup) recurGroup.style.display = 'none';
                    if (dateGroup) dateGroup.style.display = 'none';
                    const nameLabel = document.getElementById('tm-name-label');
                    if (nameLabel) nameLabel.textContent = "Event Name";
                    setVal('tm-location', task.location);
                } else {
                    title.textContent = "Edit Task";
                    if (locationGroup) locationGroup.style.display = 'none';
                    if (recurGroup) recurGroup.style.display = 'flex';
                    if (dateGroup) dateGroup.style.display = 'none';
                    const nameLabel = document.getElementById('tm-name-label');
                    if (nameLabel) nameLabel.textContent = "Task Name";
                }

                setVal('tm-text', task.title || task.text);
                setVal('tm-start', task.startTime);
                setVal('tm-end', task.endTime);
                document.getElementById('start-time-display').textContent = task.startTime;
                document.getElementById('end-time-display').textContent = task.endTime;
                setVal('tm-note', task.note);

                const taskDate = task.date || getTodayStr();
                setVal('tm-date', taskDate);
                if (headerDate) headerDate.textContent = formatDateForHeader(taskDate);

                // Recurring check
                setCheck('tm-recur', false); // Default false for one-time instance edit
                toggleRecurOptions();

                // Reminder check
                if (task.reminder && task.reminder.enabled) {
                    setCheck('tm-remind', true);
                    setVal('tm-remind-val', task.reminder.offset);
                    setVal('tm-remind-unit', task.reminder.offsetUnit);
                } else {
                    setCheck('tm-remind', false);
                }
                toggleRemindOptions();

            } else {
                // Adding
                setVal('tm-text', '');
                setVal('tm-location', ''); // Reset location
                setVal('tm-start', '00:00');
                setVal('tm-end', '00:00');
                document.getElementById('start-time-display').textContent = '00:00';
                document.getElementById('end-time-display').textContent = '00:00';
                setVal('tm-note', '');

                const initialDate = date || getTodayStr();
                setVal('tm-date', initialDate);
                if (headerDate) headerDate.textContent = formatDateForHeader(initialDate);

                setCheck('tm-recur', false);
                toggleRecurOptions();

                // Reminder Default
                setCheck('tm-remind', false);
                toggleRemindOptions();

                // Reset days
                document.querySelectorAll('.day-cb').forEach(cb => cb.checked = false);

                // Default to Random Color for new tasks
                const randomColors = ['#F87171', '#FB923C', '#FBBF24', '#A3E635', '#34D399', '#22D3EE', '#60A5FA', '#818CF8', '#C084FC', '#F472B6'];
                const randomColor = randomColors[Math.floor(Math.random() * randomColors.length)];
                setVal('tm-color', randomColor);
            }

            // Calc duration initially
            calcDuration();

            // Show Modal
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        // Helper to format date for header (e.g. "Dec 14, 2025")
        function formatDateForHeader(dateStr) {
            if (!dateStr) return '';
            const [y, m, d] = dateStr.split('-').map(Number);
            const date = new Date(y, m - 1, d);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        let selectedDayActionDate = null;

        function openDayActionPopup(dateStr) {
            triggerGlobalAction('close');
            selectedDayActionDate = dateStr;
            const popup = document.getElementById('day-action-popup');
            const dateSpan = document.getElementById('day-action-date');

            // Format date for display
            const [y, m, d] = dateStr.split('-').map(Number);
            const dateObj = new Date(y, m - 1, d);
            const formatted = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            const listContainer = document.getElementById('day-action-list');
            listContainer.innerHTML = ''; // Clear previous

            // Fetch tasks for this date
            const tasks = getTasksForDate(dateStr);

            if (tasks.length === 0) {
                listContainer.innerHTML = '<div style="color:var(--text-light); text-align:center; padding:12px;">No tasks planned.</div>';
            } else {
                tasks.forEach(task => {
                    const item = document.createElement('div');
                    item.style.cssText = `
                        padding: 12px;
                        background: #f8fafc;
                        border-radius: 8px;
                        margin-bottom: 8px;
                        cursor: pointer;
                        border-left: 4px solid ${task.color || '#0284c7'};
                    `;

                    // Robust Title Resolution
                    let displayTitle = task.title || task.text || 'Untitled Task';
                    if (displayTitle === 'undefined') displayTitle = 'Untitled Task';

                    const time = (task.startTime && task.endTime) ? `${task.startTime} - ${task.endTime}` : 'All Day';

                    item.innerHTML = `
                        <div style="font-weight:600; color:var(--text-dark);">${displayTitle}</div>
                        <div style="font-size:0.85rem; color:var(--text-light);">${time}</div>
                    `;

                    // Allow clicking to edit/view details
                    item.onclick = (e) => {
                        e.stopPropagation();
                        openTaskDetails(task.id);
                    };

                    listContainer.appendChild(item);
                });
            }

            dateSpan.textContent = formatted;
            popup.style.display = 'flex';
        }

        function closeDayActionPopup() {
            const popup = document.getElementById('day-action-popup');
            if (popup) popup.style.display = 'none';
        }

        function openTaskModalFromChoice(mode) {
            closeDayActionPopup();
            // Open modal with selected date and mode
            openTaskModal(null, selectedDayActionDate, mode);
        }

        async function saveTaskFromModal() {
            const saveBtn = document.querySelector('#tm-save-btn');
            if (saveBtn) saveBtn.disabled = true; // Prevent double clicks

            const text = document.getElementById('tm-text').value.trim();
            const errorMsg = document.getElementById('tm-error-msg');

            // Clear previous error
            if (errorMsg) errorMsg.style.display = 'none';

            // Validation: Task Name
            if (!text) {
                if (errorMsg) {
                    errorMsg.textContent = "Please enter a task name.";
                    errorMsg.style.display = 'block';
                }
                if (saveBtn) saveBtn.disabled = false;
                return;
            }

            const startTime = document.getElementById('tm-start').value;
            const endTime = document.getElementById('tm-end').value;
            const endsNextDay = document.getElementById('tm-ends-next-day').value === 'true';

            const task = {
                id: document.getElementById('tm-id').value || crypto.randomUUID(),
                title: text, // Correct property
                date: document.getElementById('tm-date').value,
                startTime: document.getElementById('tm-start').value,
                endTime: document.getElementById('tm-end').value,
                endsNextDay: document.getElementById('tm-ends-next-day').value === 'true',
                note: document.getElementById('tm-note').value.trim(),
                createdAt: new Date().toISOString(),
                location: document.getElementById('tm-location').value.trim(),
                color: document.getElementById('tm-color').value || '#e0f2fe',
                borderColor: document.getElementById('tm-color').value || '#0284c7',
                textColor: '#0369a1',
                checked: false
            };

            console.log('[DEBUG] Saving task:', task);
            console.log('[DEBUG] Date value:', document.getElementById('tm-date').value);

            // --- SUPABASE PERSISTENCE ---
            if (currentUser) {
                try {
                    const dbTask = {
                        id: task.id,
                        user_id: currentUser.id,
                        title: task.title,
                        date: task.date,
                        start_time: task.startTime,
                        end_time: task.endTime,
                        ends_next_day: task.endsNextDay,
                        note: task.note,
                        // location: task.location, // Unknown column
                        // color: task.color, // Column missing in DB
                        // border_color: task.borderColor, // Column missing in DB
                        // text_color: task.textColor,     // Column missing in DB
                        checked: task.checked,
                        status: task.checked ? 'completed' : 'todo'
                        // ends_next_day: task.endsNextDay // Unknown column
                    };

                    const { error } = await supabase
                        .from('tasks')
                        .upsert(dbTask);

                    if (error) throw error;
                    console.log("Task saved to DB:", dbTask);
                } catch (e) {
                    console.error("Supabase Save Error:", e);
                    alert("Error saving to database: " + e.message);
                    // We still save locally below, but warn user
                }
            }

            const existingIndex = appData.tasks.findIndex(t => t.id === task.id);
            if (existingIndex > -1) {
                appData.tasks[existingIndex] = { ...appData.tasks[existingIndex], ...task };
            } else {
                appData.tasks.push(task);
            }

            saveData();
            renderTasks();
            // Update Calendar too to reflect new task immediately
            if (currentCalendarView === 'month' || currentCalendarView === 'week') {
                const now = new Date(); // Use local date ref
                renderCalendar(now.getFullYear(), now.getMonth());
            }
            closeTaskModal();
        }

        // Validation: Time Logic (Start < End if same day)
        function calcDuration() {
            const start = document.getElementById('tm-start').value;
            const end = document.getElementById('tm-end').value;
            const endsNextDay = document.getElementById('tm-ends-next-day').value === 'true';
            const dur = document.getElementById('tm-duration');

            if (start && end) {
                const [sh, sm] = start.split(':').map(Number);
                const [eh, em] = end.split(':').map(Number);
                let startMins = sh * 60 + sm;
                let endMins = eh * 60 + em;

                // Add 24 hours if task ends next day
                if (endsNextDay) {
                    endMins += 24 * 60;
                }

                const diff = endMins - startMins;

                if (diff > 0) {
                    const hours = Math.floor(diff / 60);
                    const mins = diff % 60;
                    dur.value = hours > 0 ? `${hours}h ${mins} m` : `${mins} m`;
                } else {
                    // Show 0h 0m instead of Invalid
                    dur.value = '0h 0m';
                }

                // Update timeline visualization
                updateTimelineVisualization();
            } else {
                dur.value = '';
                // Hide timeline if no times selected
                document.getElementById('time-allocation-timeline').style.display = 'none';
            }
        }

        function formatDurationInput(input) {
            let value = input.value;
            let cursorPos = input.selectionStart;

            // Extract hours and minutes separately
            const hMatch = value.match(/(\d+)h/);
            const mMatch = value.match(/(\d+)m/);

            let hours = hMatch ? parseInt(hMatch[1]) : 0;
            let minutes = mMatch ? parseInt(mMatch[1]) : 0;

            // Validate and limit
            hours = Math.max(0, Math.min(23, hours)); // Max 23 hours
            minutes = Math.max(0, Math.min(59, minutes)); // Max 59 minutes

            // Format the value
            const newValue = `${hours}h ${minutes} m`;

            // Only update if changed to avoid cursor jumping
            if (input.value !== newValue) {
                input.value = newValue;

                // Try to maintain cursor position intelligently
                if (cursorPos <= 2) {
                    // Editing hours
                    input.setSelectionRange(cursorPos, cursorPos);
                } else if (cursorPos >= value.indexOf('m') - 2) {
                    // Editing minutes
                    const mPos = newValue.indexOf('m');
                    input.setSelectionRange(mPos - 1, mPos - 1);
                } else {
                    // In between, place after hours
                    const hPos = newValue.indexOf('h');
                    input.setSelectionRange(hPos, hPos);
                }
            }
        }

        function calculateTimeFromDuration() {
            const durationInput = document.getElementById('tm-duration').value.trim();
            const start = document.getElementById('tm-start').value;
            const end = document.getElementById('tm-end').value;

            // Parse duration input (e.g., "1h 30m", "90m", "1.5h")
            if (!durationInput || durationInput === '--') return;

            let totalMinutes = 0;

            // Parse hours and minutes
            const hourMatch = durationInput.match(/(\d+(?:\.\d+)?)\s*h/i);
            const minMatch = durationInput.match(/(\d+)\s*m/i);

            if (hourMatch) {
                totalMinutes += parseFloat(hourMatch[1]) * 60;
            }
            if (minMatch) {
                totalMinutes += parseInt(minMatch[1]);
            }

            // If only a number is provided, assume it's minutes
            if (!hourMatch && !minMatch) {
                const numMatch = durationInput.match(/^\d+$/);
                if (numMatch) {
                    totalMinutes = parseInt(numMatch[0]);
                }
            }

            if (totalMinutes <= 0) return;

            // Calculate missing time
            if (start && !end) {
                // Calculate end time from start + duration
                const [sh, sm] = start.split(':').map(Number);
                const startMins = sh * 60 + sm;
                const endMins = startMins + totalMinutes;

                const endHour = Math.floor(endMins / 60) % 24;
                const endMin = endMins % 60;
                const endTime = `${String(endHour).padStart(2, '0')}:${String(endMin).padStart(2, '0')} `;

                document.getElementById('tm-end').value = endTime;
                document.getElementById('end-time-display').textContent = endTime;
                updateTimelineVisualization();
            } else if (end && !start) {
                // Calculate start time from end - duration
                const [eh, em] = end.split(':').map(Number);
                const endMins = eh * 60 + em;
                const startMins = endMins - totalMinutes;

                if (startMins >= 0) {
                    const startHour = Math.floor(startMins / 60) % 24;
                    const startMin = startMins % 60;
                    const startTime = `${String(startHour).padStart(2, '0')}:${String(startMin).padStart(2, '0')} `;

                    document.getElementById('tm-start').value = startTime;
                    document.getElementById('start-time-display').textContent = startTime;
                    updateTimelineVisualization();
                }
            }
        }

        function updateCurrentTimeProgress() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();

            // Calculate percentage of day passed (0-100)
            const totalMinutesInDay = 24 * 60;
            const currentMinutes = hours * 60 + minutes;
            const percentage = (currentMinutes / totalMinutesInDay) * 100;

            // Update progress bar
            const fill = document.getElementById('time-progress-fill');
            const dot = document.getElementById('time-progress-dot');
            const label = document.getElementById('current-time-label');

            if (fill && dot && label) {
                fill.style.width = percentage + '%';
                dot.style.left = percentage + '%';
                label.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')} `;
            }
        }

        function toggleTimelineExpand() {
            const content = document.getElementById('timeline-content');
            const arrow = document.getElementById('timeline-arrow');

            if (content.style.maxHeight && content.style.maxHeight !== '0px') {
                // Collapse
                content.style.overflow = 'hidden'; // Immediately hide overflow for transition
                content.style.maxHeight = '0px';
                arrow.style.transform = 'rotate(0deg)';
                // Remove transition listener if any exists from expanding
                content.ontransitionend = null;
            } else {
                // Expand
                arrow.style.transform = 'rotate(180deg)';
                content.style.maxHeight = content.scrollHeight + "px";

                // Set overflow to visible AFTER transition to allow tooltips to show
                content.ontransitionend = () => {
                    if (content.style.maxHeight !== '0px') {
                        content.style.overflow = 'visible';
                    }
                };
            }
        }

        function expandTimeline() {
            const content = document.getElementById('timeline-content');
            const arrow = document.getElementById('timeline-arrow');

            if (!content || !arrow) return;

            // Expand
            content.style.maxHeight = content.scrollHeight + 'px';
            arrow.style.transform = 'rotate(180deg)';
        }

        function renderTimelineSegments() {
            const container = document.getElementById('timeline-container');
            if (!container) return;

            container.innerHTML = ''; // Clear existing segments

            // Get current task date
            const taskDate = document.getElementById('tm-date').value || getTodayStr();
            const isRecurring = document.getElementById('tm-recur').checked;
            const currentTaskId = document.getElementById('tm-id').value;

            // Get today's day name for recurring tasks
            const daysMap = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const taskDateObj = new Date(taskDate);
            const taskDayName = daysMap[taskDateObj.getDay()];

            // Collect all allocated time slots for this day
            const allocatedSlots = [];

            appData.tasks.forEach(task => {
                // Skip the current task being edited
                if (currentTaskId && task.id === currentTaskId) return;

                // Check if task applies to this date
                let appliesToDate = false;

                if (task.date === taskDate) {
                    appliesToDate = true;
                } else if (task.recurDays && Array.isArray(task.recurDays) && task.recurDays.includes(taskDayName)) {
                    appliesToDate = true;
                }

                if (appliesToDate && task.startTime && task.endTime) {
                    const [sh, sm] = task.startTime.split(':').map(Number);
                    const [eh, em] = task.endTime.split(':').map(Number);
                    allocatedSlots.push({
                        start: sh * 60 + sm,
                        end: eh * 60 + em,
                        taskName: task.text
                    });
                }
            });

            // Render 24-hour timeline (0-1440 minutes)
            const totalMinutes = 24 * 60;

            // Sort allocated slots
            allocatedSlots.sort((a, b) => a.start - b.start);

            // Merge overlapping slots
            const mergedSlots = [];
            allocatedSlots.forEach(slot => {
                if (mergedSlots.length === 0) {
                    mergedSlots.push({ ...slot });
                } else {
                    const last = mergedSlots[mergedSlots.length - 1];
                    if (slot.start <= last.end) {
                        last.end = Math.max(last.end, slot.end);
                        last.taskName += ', ' + slot.taskName;
                    } else {
                        mergedSlots.push({ ...slot });
                    }
                }
            });

            // Render allocated segments (red)
            mergedSlots.forEach(slot => {
                const startPercent = (slot.start / totalMinutes) * 100;
                const widthPercent = ((slot.end - slot.start) / totalMinutes) * 100;

                const segment = document.createElement('div');
                segment.style.cssText = `
                position: absolute;
                left: ${startPercent}%;
                width: ${widthPercent}%;
                height: 100 %;
                background: #f87171;
                border - right: 1px solid #fff;
                `;
                segment.title = `Allocated: ${slot.taskName} `;
                container.appendChild(segment);
            });

            // Render available segments (green) - fill gaps
            let lastEnd = 0;
            mergedSlots.forEach(slot => {
                if (slot.start > lastEnd) {
                    const startPercent = (lastEnd / totalMinutes) * 100;
                    const widthPercent = ((slot.start - lastEnd) / totalMinutes) * 100;

                    const segment = document.createElement('div');
                    segment.style.cssText = `
                position: absolute;
                left: ${startPercent}%;
                width: ${widthPercent}%;
                height: 100 %;
                background: #4ade80;
                border - right: 1px solid #fff;
                `;
                    segment.title = 'Available';
                    container.appendChild(segment);
                }
                lastEnd = slot.end;
            });

            // Fill remaining time if any
            if (lastEnd < totalMinutes) {
                const startPercent = (lastEnd / totalMinutes) * 100;
                const widthPercent = ((totalMinutes - lastEnd) / totalMinutes) * 100;

                const segment = document.createElement('div');
                segment.style.cssText = `
                position: absolute;
                left: ${startPercent}%;
                width: ${widthPercent}%;
                height: 100 %;
                background: #4ade80;
                `;
                segment.title = 'Available';
                container.appendChild(segment);
            }
        }

        function updateTimelineVisualization() {
            const start = document.getElementById('tm-start').value;
            const end = document.getElementById('tm-end').value;
            const timeline = document.getElementById('time-allocation-timeline');
            const conflictWarning = document.getElementById('conflict-warning');
            const conflictMessage = document.getElementById('conflict-message');

            if (!start || !end) {
                timeline.style.display = 'none';
                return;
            }

            // Show timeline
            timeline.style.display = 'block';

            // Auto-expand timeline when times are set
            expandTimeline();

            // Update current time progress
            updateCurrentTimeProgress();

            // Render base timeline
            renderTimelineSegments();

            // Add selected time overlay (yellow)
            const [sh, sm] = start.split(':').map(Number);
            const [eh, em] = end.split(':').map(Number);
            const startMins = sh * 60 + sm;
            const endMins = eh * 60 + em;

            if (endMins > startMins) {
                const totalMinutes = 24 * 60;
                const startPercent = (startMins / totalMinutes) * 100;
                const widthPercent = ((endMins - startMins) / totalMinutes) * 100;

                const container = document.getElementById('timeline-container');
                const selectedSegment = document.createElement('div');
                selectedSegment.style.cssText = `
                position: absolute;
                left: ${startPercent}%;
                width: ${widthPercent}%;
                height: 100 %;
                background: rgba(251, 191, 36, 0.7);
                border: 2px solid #f59e0b;
                box - sizing: border - box;
                pointer - events: none;
                `;
                selectedSegment.title = 'Selected Time';
                container.appendChild(selectedSegment);
                if (container) container.appendChild(selectedSegment);
            }

            // Check for conflicts
            const taskDate = document.getElementById('tm-date').value || getTodayStr();
            const currentTaskId = document.getElementById('tm-id').value;
            const isRecurring = document.getElementById('tm-recur').checked;
            // Check for conflicts
            const conflict = checkTimeConflict(start, end, currentTaskId, taskDate, isRecurring);
            if (conflict && conflictWarning && conflictMessage) {
                conflictWarning.style.display = 'block';
                conflictMessage.textContent = `Time overlaps with: "${conflict.text}"(${conflict.startTime} - ${conflict.endTime})`;
                // Recalculate dropdown height to accommodate warning
                updateDropdownHeight();
            } else if (conflictWarning) {
                conflictWarning.style.display = 'none';
                // Recalculate dropdown height after hiding warning
                updateDropdownHeight();
            }
        }

        function updateDropdownHeight() {
            const content = document.getElementById('timeline-content');
            if (content && content.style.maxHeight !== '0px') {
                // Only update if expanded
                setTimeout(() => {
                    content.style.maxHeight = content.scrollHeight + 'px';
                }, 10);
            }
        }

        function initializeTimeDropdowns() {
            // Initialize popup time picker scroll containers
            initializePopupScrollPicker('popup-hour-scroll', 'hour');
            initializePopupScrollPicker('popup-min-scroll', 'minute');
        }

        let currentTimePickerType = null; // 'start' or 'end'
        let tempSelectedTime = { hour: '00', minute: '00' };

        function initializePopupScrollPicker(containerId, type) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const max = type === 'hour' ? 24 : 60;

            // Add padding options for scroll snap
            for (let i = 0; i < 2; i++) {
                const padding = document.createElement('div');
                padding.className = 'time-option-popup';
                padding.style.visibility = 'hidden';
                container.appendChild(padding);
            }

            // Add time options THREE TIMES for infinite loop effect
            // First set (for wrapping from start)
            for (let i = 0; i < max; i++) {
                const option = document.createElement('div');
                option.className = 'time-option-popup';
                option.textContent = String(i).padStart(2, '0');
                option.dataset.value = String(i).padStart(2, '0');
                option.dataset.set = 'first';
                container.appendChild(option);
            }

            // Second set (main set)
            for (let i = 0; i < max; i++) {
                const option = document.createElement('div');
                option.className = 'time-option-popup';
                option.textContent = String(i).padStart(2, '0');
                option.dataset.value = String(i).padStart(2, '0');
                option.dataset.set = 'main';
                container.appendChild(option);
            }

            // Third set (for wrapping from end)
            for (let i = 0; i < max; i++) {
                const option = document.createElement('div');
                option.className = 'time-option-popup';
                option.textContent = String(i).padStart(2, '0');
                option.dataset.value = String(i).padStart(2, '0');
                option.dataset.set = 'last';
                container.appendChild(option);
            }

            // Add padding at end
            for (let i = 0; i < 2; i++) {
                const padding = document.createElement('div');
                padding.className = 'time-option-popup';
                padding.style.visibility = 'hidden';
                container.appendChild(padding);
            }

            // Handle scroll events for automatic selection and infinite loop
            let scrollTimeout;
            let isWrapping = false;

            container.addEventListener('scroll', () => {
                if (isWrapping) return;

                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    updatePopupSelectedFromScroll(container, type);
                    handleInfiniteScroll(container, max);
                }, 100);
            });

            // Handle infinite scroll wrapping
            function handleInfiniteScroll(container, max) {
                const optionHeight = 44;
                const setHeight = max * optionHeight;
                const scrollTop = container.scrollTop;
                const paddingHeight = 2 * optionHeight;

                // If scrolled to first set, wrap to main set
                if (scrollTop < paddingHeight + setHeight / 2) {
                    isWrapping = true;
                    container.scrollTop = scrollTop + setHeight;
                    setTimeout(() => { isWrapping = false; }, 50);
                }
                // If scrolled to last set, wrap to main set
                else if (scrollTop > paddingHeight + setHeight * 2 + setHeight / 2) {
                    isWrapping = true;
                    container.scrollTop = scrollTop - setHeight;
                    setTimeout(() => { isWrapping = false; }, 50);
                }
            }

            // Handle mouse wheel for precise scrolling (one option per scroll)
            container.addEventListener('wheel', (e) => {
                e.preventDefault();

                const optionHeight = 44;
                const delta = e.deltaY > 0 ? optionHeight : -optionHeight;

                container.scrollBy({
                    top: delta,
                    behavior: 'smooth'
                });
            }, { passive: false });

            // Initialize scroll position to main set (middle)
            setTimeout(() => {
                const optionHeight = 44;
                const paddingHeight = 2 * optionHeight;
                const setHeight = max * optionHeight;
                container.scrollTop = paddingHeight + setHeight; // Start at main set
            }, 10);
        }

        function openTimePicker(type) {
            currentTimePickerType = type;
            const modal = document.getElementById('time-picker-modal');
            const title = document.getElementById('time-picker-title');

            // Set title
            title.textContent = type === 'start' ? 'Select Start Time' : 'Select End Time';

            // Get current time value
            const currentTime = document.getElementById(`tm-${type}`).value || '00:00';
            const [hour, minute] = currentTime.split(':');

            // Store temp values
            tempSelectedTime = { hour, minute };

            // Handle tomorrow toggle for end time
            const tomorrowContainer = document.getElementById('tomorrow-toggle-container');
            const tomorrowToggle = document.getElementById('tomorrow-toggle');

            if (type === 'end') {
                // Load existing tomorrow flag
                const endsNextDay = document.getElementById('tm-ends-next-day').value === 'true';
                tomorrowToggle.checked = endsNextDay;
                // Will show/hide based on time comparison in scroll handler
                tomorrowContainer.style.display = 'block';
            } else {
                tomorrowContainer.style.display = 'none';
            }

            // Scroll to current values
            setTimeout(() => {
                scrollToValue('popup-hour-scroll', hour);
                scrollToValue('popup-min-scroll', minute);
                // Update tomorrow toggle visibility after scroll
                if (type === 'end') {
                    updateTomorrowToggleVisibility();
                }
            }, 50);

            // Show modal
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function closeTimePicker(save) {
            const modal = document.getElementById('time-picker-modal');

            if (save) {
                // Save the selected time
                const timeStr = `${tempSelectedTime.hour.padStart(2, '0')}:${tempSelectedTime.minute.padStart(2, '0')}`;
                document.getElementById(`tm-${currentTimePickerType}`).value = timeStr;
                document.getElementById(`${currentTimePickerType}-time-display`).textContent = timeStr;

                // Save tomorrow flag if editing end time
                if (currentTimePickerType === 'end') {
                    const tomorrowToggle = document.getElementById('tomorrow-toggle');
                    document.getElementById('tm-ends-next-day').value = tomorrowToggle.checked ? 'true' : 'false';
                }

                // Recalculate duration
                calcDuration();
            }

            // Hide modal
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                currentTimePickerType = null;
            }, 300);
        }

        function updateTomorrowToggleVisibility() {
            if (currentTimePickerType !== 'end') return;

            const startTime = document.getElementById('tm-start').value;
            if (!startTime) return;

            const [startH, startM] = startTime.split(':').map(Number);
            const endH = parseInt(tempSelectedTime.hour);
            const endM = parseInt(tempSelectedTime.minute);

            const startMins = startH * 60 + startM;
            const endMins = endH * 60 + endM;

            const tomorrowContainer = document.getElementById('tomorrow-toggle-container');

            // Show toggle only if end time is before start time (crosses midnight)
            if (endMins < startMins) {
                tomorrowContainer.style.display = 'block';
            } else {
                // Same day - hide toggle and uncheck
                tomorrowContainer.style.display = 'none';
                document.getElementById('tomorrow-toggle').checked = false;
                document.getElementById('tm-ends-next-day').value = 'false';
            }
        }

        function scrollToValue(containerId, value) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Find the option in the MAIN set (middle set) for infinite loop
            const option = Array.from(container.querySelectorAll('.time-option-popup')).find(
                opt => opt.dataset.value === value && opt.dataset.set === 'main'
            );

            if (option) {
                const containerHeight = container.clientHeight;
                const optionTop = option.offsetTop;
                const optionHeight = option.clientHeight;
                const scrollTo = optionTop - (containerHeight / 2) + (optionHeight / 2);

                container.scrollTo({
                    top: scrollTo,
                    behavior: 'instant'
                });

                // Mark as selected
                container.querySelectorAll('.time-option-popup').forEach(opt => {
                    opt.classList.remove('selected');
                });
                option.classList.add('selected');
            }
        }

        function updatePopupSelectedFromScroll(container, type) {
            const containerHeight = container.clientHeight;
            const scrollTop = container.scrollTop;
            const centerPosition = scrollTop + (containerHeight / 2);

            let closestOption = null;
            let closestDistance = Infinity;

            container.querySelectorAll('.time-option-popup').forEach(option => {
                if (option.style.visibility === 'hidden') return;

                const optionTop = option.offsetTop;
                const optionHeight = option.clientHeight;
                const optionCenter = optionTop + (optionHeight / 2);
                const distance = Math.abs(centerPosition - optionCenter);

                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestOption = option;
                }
            });

            if (closestOption) {
                container.querySelectorAll('.time-option-popup').forEach(opt => {
                    opt.classList.remove('selected');
                });
                closestOption.classList.add('selected');

                // Update temp selected time
                if (type === 'hour') {
                    tempSelectedTime.hour = closestOption.dataset.value;
                } else if (type === 'minute') {
                    tempSelectedTime.minute = closestOption.dataset.value;
                }

                // Update tomorrow toggle visibility when time changes
                updateTomorrowToggleVisibility();
            }
        }

        function initializeScrollPicker(containerId, type, timeInputId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const max = type === 'hour' ? 24 : 60;

            // Add padding options for scroll snap
            for (let i = 0; i < 1; i++) {
                const padding = document.createElement('div');
                padding.className = 'time-option';
                padding.style.visibility = 'hidden';
                container.appendChild(padding);
            }

            // Add time options
            for (let i = 0; i < max; i++) {
                const option = document.createElement('div');
                option.className = 'time-option';
                option.textContent = String(i).padStart(2, '0');
                option.dataset.value = String(i).padStart(2, '0');
                container.appendChild(option);
            }

            // Add padding at end
            for (let i = 0; i < 1; i++) {
                const padding = document.createElement('div');
                padding.className = 'time-option';
                padding.style.visibility = 'hidden';
                container.appendChild(padding);
            }

            // Handle scroll events for automatic selection
            let scrollTimeout;
            container.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    updateSelectedFromScroll(container, timeInputId);
                }, 100);
            });

            // Set default to 00 (scroll to first option)
            setTimeout(() => {
                const firstOption = container.querySelector('.time-option[data-value="00"]');
                if (firstOption) {
                    const containerHeight = container.clientHeight;
                    const optionTop = firstOption.offsetTop;
                    const optionHeight = firstOption.clientHeight;
                    const scrollTo = optionTop - (containerHeight / 2) + (optionHeight / 2);

                    container.scrollTo({
                        top: scrollTo,
                        behavior: 'instant'
                    });

                    firstOption.classList.add('selected');
                    updateTimeFromPickers(timeInputId);
                }
            }, 50);
        }

        function updateSelectedFromScroll(container, timeInputId) {
            const containerHeight = container.clientHeight;
            const scrollTop = container.scrollTop;
            const centerPosition = scrollTop + (containerHeight / 2);

            let closestOption = null;
            let closestDistance = Infinity;

            container.querySelectorAll('.time-option').forEach(option => {
                if (option.style.visibility === 'hidden') return;

                const optionTop = option.offsetTop;
                const optionHeight = option.clientHeight;
                const optionCenter = optionTop + (optionHeight / 2);
                const distance = Math.abs(centerPosition - optionCenter);

                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestOption = option;
                }
            });

            if (closestOption) {
                container.querySelectorAll('.time-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                closestOption.classList.add('selected');
                updateTimeFromPickers(timeInputId);
            }
        }

        function updateTimeFromPickers(timeInputId) {
            let hourValue, minValue;

            if (timeInputId === 'tm-start') {
                const hourContainer = document.getElementById('tm-start-hour-scroll');
                const minContainer = document.getElementById('tm-start-min-scroll');

                hourValue = hourContainer.querySelector('.time-option.selected')?.dataset.value || '';
                minValue = minContainer.querySelector('.time-option.selected')?.dataset.value || '';
            } else if (timeInputId === 'tm-end') {
                const hourContainer = document.getElementById('tm-end-hour-scroll');
                const minContainer = document.getElementById('tm-end-min-scroll');

                hourValue = hourContainer.querySelector('.time-option.selected')?.dataset.value || '';
                minValue = minContainer.querySelector('.time-option.selected')?.dataset.value || '';
            }

            const hiddenInput = document.getElementById(timeInputId);
            if (hourValue && minValue) {
                hiddenInput.value = `${hourValue}:${minValue} `;
            } else {
                hiddenInput.value = '';
            }

            calcDuration();
        }

        function setTimeDropdowns(timeInputId, timeValue) {
            if (!timeValue) {
                // Reset - no selection
                return;
            }

            const [hour, min] = timeValue.split(':');

            if (timeInputId === 'tm-start') {
                setScrollPickerValue('tm-start-hour-scroll', hour);
                setScrollPickerValue('tm-start-min-scroll', min);
            } else if (timeInputId === 'tm-end') {
                setScrollPickerValue('tm-end-hour-scroll', hour);
                setScrollPickerValue('tm-end-min-scroll', min);
            }
        }

        function setScrollPickerValue(containerId, value) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const option = Array.from(container.querySelectorAll('.time-option')).find(
                opt => opt.dataset.value === value
            );

            if (option) {
                // Scroll to center the option
                const containerHeight = container.clientHeight;
                const optionTop = option.offsetTop;
                const optionHeight = option.clientHeight;
                const scrollTo = optionTop - (containerHeight / 2) + (optionHeight / 2);

                container.scrollTo({
                    top: scrollTo,
                    behavior: 'smooth'
                });

                // Mark as selected
                container.querySelectorAll('.time-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                option.classList.add('selected');

                // Update time
                const timeInputId = containerId.includes('start') ? 'tm-start' : 'tm-end';
                updateTimeFromPickers(timeInputId);
            }
        }

        function updateTimelineIfVisible() {
            const start = document.getElementById('tm-start').value;
            const end = document.getElementById('tm-end').value;

            // Only update timeline if both times are selected
            if (start && end) {
                updateTimelineVisualization();
            }
        }

        function closeTaskModal() {
            const modal = document.getElementById('task-modal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        // --- GLOBAL CONFIRM STATE ---
        let pendingConfirm = null; // {section, id}

        function toggleRecurOptions() {
            const isRecur = document.getElementById('tm-recur').checked;
            document.getElementById('recur-options').style.display = isRecur ? 'block' : 'none';
            document.getElementById('tm-date').parentElement.style.display = isRecur ? 'none' : 'block';
        }

        function toggleRemindOptions() {
            const isRemind = document.getElementById('tm-remind').checked;
            document.getElementById('remind-options').style.display = isRemind ? 'block' : 'none';
        }





        function checkTimeConflict(start, end, excludeId = null, taskDate = null, isRecurring = false) {
            // Check global list
            const [sh, sm] = start.split(':').map(Number);
            const [eh, em] = end.split(':').map(Number);
            const startMins = sh * 60 + sm;
            const endMins = eh * 60 + em;

            // Get today's date for comparison
            const todayStr = getTodayStr();
            const daysMap = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const todayName = daysMap[new Date().getDay()];

            return appData.tasks.find(t => {
                if (excludeId && t.id === excludeId) return false;
                if (!t.startTime || !t.endTime) return false;

                // Only check conflicts for tasks on the SAME DAY
                // For recurring tasks, check if they appear today
                // For dated tasks, check if the date matches
                let isOnSameDay = false;

                if (isRecurring) {
                    // New task is recurring - check against today's tasks
                    if (t.date === todayStr) isOnSameDay = true;
                    if (t.recurDays && Array.isArray(t.recurDays) && t.recurDays.includes(todayName)) isOnSameDay = true;
                } else if (taskDate) {
                    // New task has a specific date - only check tasks on that date
                    if (t.date === taskDate) isOnSameDay = true;
                    if (t.recurDays && Array.isArray(t.recurDays)) {
                        // Check if recurring task appears on taskDate
                        const taskDateObj = new Date(taskDate);
                        const taskDayName = daysMap[taskDateObj.getDay()];
                        if (t.recurDays.includes(taskDayName)) isOnSameDay = true;
                    }
                }

                if (!isOnSameDay) return false;

                const [tSh, tSm] = t.startTime.split(':').map(Number);
                const [tEh, tEm] = t.endTime.split(':').map(Number);
                const tStartMins = tSh * 60 + tSm;
                const tEndMins = tEh * 60 + tEm;

                // Overlap: (StartA < EndB) and (EndA > StartB)
                return (startMins < tEndMins && endMins > tStartMins);
            });
        }

        let currentActionContext = { section: null, id: null };

        // --- GLOBAL ACTIONS ---
        function openMenu(e, id) {
            e.stopPropagation();
            e.preventDefault();

            // Close others
            triggerGlobalAction('close');

            // Find Button even if clicked on icon
            const btn = e.target.closest('button') || e.target;
            const rect = btn.getBoundingClientRect();

            // Create Menu
            const wrapper = document.createElement('ul');
            wrapper.className = 'action-menu show';

            // Position FIXED relative to viewport
            // Default: Open down-left (align right edge of menu to right edge of button)
            let top = rect.bottom + 4;
            let left = rect.right - 140; // 140 is width defined in CSS

            // Check bottom edge overflow
            if (rect.bottom + 150 > window.innerHeight) {
                top = rect.top - 110; // Open Up (approx height of menu)
            }

            // Check left edge overflow (if button is too far left?)
            if (left < 10) left = rect.left; // Align left if narrow

            wrapper.style.top = `${top}px`;
            wrapper.style.left = `${left}px`;

            wrapper.innerHTML = `
                    <li class="action-item" onclick="openTaskModal('${id}')">Settings</li>

                        <li class="action-item delete" onclick="openDeleteModal('${id}')">Delete</li>
                `;

            // Append to BODY to escape overflows
            document.body.appendChild(wrapper);
        }

        function triggerGlobalAction(action) {
            if (action === 'close') {
                document.querySelectorAll('.action-menu').forEach(el => el.remove());
            }
        }

        // --- DELETE SAFETY ---
        let pendingDeleteId = null;

        function openDeleteModal(id) {
            triggerGlobalAction('close');
            pendingDeleteId = id;

            // Reset UI
            document.getElementById('del-toggle').checked = false;
            const btn = document.getElementById('btn-delete-act');
            btn.classList.remove('active');

            const modal = document.getElementById('delete-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function closeDeleteModal() {
            const modal = document.getElementById('delete-modal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                pendingDeleteId = null;
            }, 300);
        }

        function toggleDeleteConfirm() {
            const isChecked = document.getElementById('del-toggle').checked;
            const btn = document.getElementById('btn-delete-act');
            if (isChecked) btn.classList.add('active');
            else btn.classList.remove('active');
        }


        function toggleSection(section) {
            // This function is no longer relevant with a single task list
            // but keeping it as a placeholder if sections are re-introduced
            // or for other UI elements.
            console.warn("toggleSection called, but sections are deprecated.");
        }

        function resetProgress() {
            try {
                if (window.confirm("Reset current checks? This will NOT save history, just clear the boxes.")) {
                    appData.tasks.forEach(t => t.checked = false);
                    saveData();
                    renderTasks();
                }
            } catch (e) {
                console.error("Reset failed", e);
                // Fallback if confirm fails? Just do it? No, risky. 
                alert("Error resetting: " + e.message);
            }
        }

        function showEndDaySummary() {
            const stats = calculateStats();
            document.getElementById('m-completion').textContent = stats.pct + '%';

            // Calculate potential streak
            let streak = appData.stats.currentStreak;
            if (stats.pct === 100) {
                // Check if we already incremented today? 
                // Actually logic says streak increases on Reset. 
                // So we show what it WILL be.
                streak = streak + 1;
                document.getElementById('m-streak-msg').style.display = 'block';
            } else {
                document.getElementById('m-streak-msg').style.display = 'none';
            }
            document.getElementById('m-streak').textContent = streak;

            const modal = document.getElementById('end-day-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function closeModal() {
            const modal = document.getElementById('end-day-modal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        function confirmEndDay() {
            // Archive History
            const today = getTodayStr();
            const stats = calculateStats();
            appData.history[today] = { pct: stats.pct };

            // Clear Checks
            appData.tasks.forEach(t => t.checked = false);

            // Update Streaks
            updateStreaksOnReset(stats.pct);

            saveData();
            renderTasks();
            renderStreak();
            updateOverview();
            updateProgress(); // Update progress bar and details

            closeModal();
            // scroll top
            document.querySelector('.main-content').scrollTop = 0;

            // Redirect to Overview
            switchView('overview');
        }

        // --- STREAK LOGIC ---
        function calculateStats() {
            const all = appData.tasks;
            if (all.length === 0) return { pct: 0, done: 0, total: 0 };
            const done = all.filter(t => t.checked).length;
            const pct = Math.round((done / all.length) * 100);
            return { pct, done, total: all.length };
        }

        function updateStreaksOnReset(todayPct) {
            // If 100%, increment streak
            if (todayPct === 100) {
                appData.stats.currentStreak++;
                if (appData.stats.currentStreak > appData.stats.bestStreak) {
                    appData.stats.bestStreak = appData.stats.currentStreak;
                }
            } else {
                appData.stats.currentStreak = 0;
            }
        }

        // --- PROGRESS & TIME STATS (Restored) ---
        // Progress Details V2 Toggle
        function toggleProgressDetails() {
            const container = document.getElementById('progress-details-v2');
            const btn = document.querySelector('.toggle-details-btn');

            if (!container) return;

            // Toggle Expand Class
            container.classList.toggle('expanded');

            // Toggle Button Rotation
            if (btn) {
                btn.classList.toggle('open');
            }
        }

        function updateProgress() {
            // Use consistent Today tasks for stats
            const tasks = getTodayTasks();
            const total = tasks.length;
            const done = tasks.filter(t => t.checked).length;

            // Recalculate Missed logic for Stats
            const now = new Date();
            const nowMins = now.getHours() * 60 + now.getMinutes();
            let missed = 0;
            let totalAllocatedMins = 0;

            tasks.forEach(t => {
                // Missed Logic
                if (t.endTime && !t.checked && t.status !== 'in_progress') {
                    const [h, m] = t.endTime.split(':').map(Number);
                    if (nowMins > h * 60 + m) missed++;
                }

                // Time Allocation Logic (Only if both start/end present)
                if (t.startTime && t.endTime) {
                    const [h1, m1] = t.startTime.split(':').map(Number);
                    const [h2, m2] = t.endTime.split(':').map(Number);
                    let startM = h1 * 60 + m1;
                    let endM = h2 * 60 + m2;
                    if (endM >= startM) {
                        totalAllocatedMins += (endM - startM);
                    }
                }
            });

            // Calculate Unallocated
            // 24 hours * 60 = 1440 mins
            const unallocatedMins = 1440 - totalAllocatedMins;

            const todo = total - done - missed;
            // Note: 'Missed' implies not done but time passed. 'Todo' implies remaining.
            // If strict: todo = total - done. Missed is a subset of todo or separate?
            // Usually: Todo (Active) + Missed + Done = Total.
            // Current simple logic: todo = total - done - missed. This is fine.

            // PROGRESS PERCENTAGE
            let pct = total === 0 ? 0 : Math.round((done / total) * 100);

            // DOM UPDATES
            const pt = document.getElementById('progress-text');
            const pf = document.getElementById('progress-fill');
            if (pt) pt.textContent = `${pct}% `;
            if (pf) pf.style.width = `${pct}% `;

            const elTotal = document.getElementById('d-total');
            if (elTotal) elTotal.textContent = total;
            const elDone = document.getElementById('d-done');
            if (elDone) elDone.textContent = done;
            const elTodo = document.getElementById('d-todo');
            if (elTodo) elTodo.textContent = todo;
            const elMissed = document.getElementById('d-missed'); // New Element
            if (elMissed) elMissed.textContent = missed;

            // Time DOM Updates
            const elAlloc = document.getElementById('d-alloc');
            if (elAlloc) {
                const h = Math.floor(totalAllocatedMins / 60);
                const m = totalAllocatedMins % 60;
                elAlloc.textContent = `${h}h ${m} m`;
            }
            const elUnalloc = document.getElementById('d-unalloc');
            if (elUnalloc) {
                const h = Math.floor(unallocatedMins / 60);
                const m = unallocatedMins % 60;
                elUnalloc.textContent = `${h}h ${m} m`;
            }
        }


        function updateTimeStats(tasks = getTodayTasks()) {
            let totalAllocMins = 0;
            tasks.forEach(t => {
                if (t.startTime && t.endTime) {
                    const [h1, m1] = t.startTime.split(':').map(Number);
                    const [h2, m2] = t.endTime.split(':').map(Number);
                    let diff = (h2 * 60 + m2) - (h1 * 60 + m1);
                    if (diff > 0) totalAllocMins += diff;
                }
            });

            // Fetch Sleep Time (Live)
            const sleepMins = (window.appData && window.appData.sleep && window.appData.sleep.durationMinutes) || 0;

            // Updated Formula: 24h - Allocated - Sleep = Unallocated
            const freeMins = (24 * 60) - totalAllocMins - sleepMins;

            const allocH = Math.floor(totalAllocMins / 60);
            const allocM = totalAllocMins % 60;
            const elAlloc = document.getElementById('d-alloc');
            if (elAlloc) elAlloc.textContent = `${allocH}h ${allocM} m`;

            const sleepH = Math.floor(sleepMins / 60);
            const sleepM = sleepMins % 60;
            const elSleep = document.getElementById('d-sleep-stat'); // New Element
            if (elSleep) elSleep.textContent = `${sleepH}h ${sleepM} m`;

            const freeH = Math.floor(freeMins / 60);
            const freeM = freeMins % 60;
            const elFree = document.getElementById('d-free');
            if (elFree) elFree.textContent = `${freeH}h ${freeM} m`;
        }

        // --- LIFECYCLE ---
        // --- LIFECYCLE (Logic Moved to Supabase Section above ~line 3900) ---
        // startTask, endTask, executeConfirmEnd are defined as async functions earlier.


        function checkReminders() {
            const now = new Date();
            const nowMins = now.getHours() * 60 + now.getMinutes();

            appData.tasks.forEach(task => {
                if (!task.checked && task.reminder && task.reminder.enabled && !task.reminder.notified) {
                    if (!task.startTime) return;

                    // Calc trigger time
                    const [h, m] = task.startTime.split(':').map(Number);
                    const startMins = h * 60 + m;

                    let offset = task.reminder.offset;
                    if (task.reminder.offsetUnit === 'hr') offset = offset * 60;

                    const triggerMins = startMins - offset;

                    // Trigger if NOW is within 1 minute tolerance of trigger
                    // OR if we passed it recently (e.g. app was closed)? 
                    // Simple check: triggerMins == nowMins

                    if (Math.abs(nowMins - triggerMins) <= 1) {
                        // NOTIFY
                        if ("Notification" in window && Notification.permission === "granted") {
                            new Notification(`Reminder: ${task.text} `, {
                                body: `Starts in ${task.reminder.offset} ${task.reminder.offsetUnit} `,
                                icon: 'https://cdn-icons-png.flaticon.com/512/2693/2693507.png'
                            });
                            // Sound?
                            // const audio = new Audio('alarm.mp3'); audio.play(); 
                        } else {
                            alert(`Reminder: ${task.text} starts soon!`);
                        }

                        task.reminder.notified = true;
                        if (typeof patchTask === 'function') {
                            patchTask(task.id, { reminder: task.reminder });
                        } else {
                            saveData();
                        }
                    }
                }
            });
        }

        // Helper to get consistent "Today" tasks
        function getTodayTasks() {
            const todayStr = getTodayStr();
            // Use explicit map for consistency with Checkboxes
            const daysMap = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayName = daysMap[new Date().getDay()];
            const tasks = appData.tasks || [];

            return tasks.filter(t => {
                // 1. Specific Date Match
                if (t.date === todayStr) return true;
                // 2. Recurring Match
                if (t.recurDays && Array.isArray(t.recurDays) && t.recurDays.includes(dayName)) return true;
                return false;
            });
        }

        // --- RENDERING ---
        function renderTasks() {
            // Stats
            // Note: updateProgress() calls calculateStats, we should perhaps rely on updateProgress mostly

            // Time for Lifecycle Buttons
            const now = new Date();
            const nowMins = now.getHours() * 60 + now.getMinutes();

            // Lists
            const container = document.getElementById('task-container');
            container.innerHTML = '';

            // SORT TASKS
            // Filter for Today using Helper
            const tasks = getTodayTasks();

            tasks.sort((a, b) => {
                const dA = a.startTime || '24:00';
                const dB = b.startTime || '24:00';
                return dA.localeCompare(dB);
            });

            const ul = document.createElement('ul');
            ul.className = 'task-list';

            tasks.forEach(task => {
                let rowClass = 'task-item';
                let isDisabled = false;
                let statusBadge = '';

                // LifeCycle Logic
                let timeBtn = '';
                if (task.startTime && task.endTime) {
                    const [h1, m1] = task.startTime.split(':').map(Number);
                    const startMins = h1 * 60 + m1;
                    const [h2, m2] = task.endTime.split(':').map(Number);
                    const endMins = h2 * 60 + m2;

                    // Check Timing
                    const isBeforeStart = nowMins < startMins;
                    const isAfterEnd = nowMins > endMins;
                    const isInProgress = task.status === 'in_progress';

                    // Strict Rules:
                    // 1. Disabled if Before Start
                    if (isBeforeStart) isDisabled = true;

                    // 2. Missed: If After End AND Not In Progress AND Not Checked
                    if (isAfterEnd && !isInProgress && !task.checked) {
                        rowClass += ' task-missed';
                        statusBadge = `<span class="status-badge-missed">NOT DONE</span>`;
                        isDisabled = true; // Inactive
                    }

                    // Show Start?
                    if (!task.checked && (nowMins >= startMins || isBeforeStart) && !isInProgress && !isAfterEnd) {
                        // Visible if reachable
                        if (nowMins >= startMins) {
                            timeBtn = `<button class="lifecycle-btn btn-start-task" onclick="startTask('${task.id}')">Start Task</button>`;
                        }
                    }

                    // Show End?
                    else if (!task.checked && (isInProgress || nowMins >= endMins)) {
                        if (isInProgress) {
                            timeBtn = `<button class="lifecycle-btn btn-end-task" onclick="endTask('${task.id}')">End Task</button>`;
                        }
                    }

                    if (isInProgress) statusBadge = `<span class="status-badge-progress">IN PROGRESS</span>`;
                }

                if (isDisabled) rowClass += ' disabled';

                const li = document.createElement('li');
                li.className = rowClass;
                // Add subtle border (User Request)
                li.style.border = '1px solid var(--border-light)';
                // Add colored left border indicator
                li.style.borderLeft = `5px solid ${task.borderColor || task.color || '#0284c7'}`;
                li.innerHTML = `
                    <div class="cb-wrapper">
                    <input type="checkbox" class="native-cb" 
                        ${task.checked ? 'checked' : ''} 
                        ${isDisabled ? 'disabled' : ''}
                        onchange="toggleCheck('${task.id}')">
                    <div class="styled-cb"></div>
                </div>
                <div style="flex-grow:1; display:flex; flex-direction:column; gap:6px; min-width:0;">
                    <!-- Row 1: Title + Status -->
                    <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                        <div class="task-text" style="flex-grow:0;">${task.title || task.text}</div>
                        ${statusBadge}
                    </div>

                    <!-- Row 2: Time + Icons -->
                    <div class="task-meta" style="margin-top:0;">
                        ${task.startTime ? `<span class="badge-time">${task.startTime} - ${task.endTime}</span>` : ''}
                        ${task.templateId ? `<span class="badge-recur"></span>` : ''}
                        ${task.reminder && task.reminder.enabled ? `<span></span>` : ''}
                    </div>
                    
                    <!-- Row 3: Notes -->
                    ${task.note ? `<div style="margin-top:2px;">
                        <span class="note-preview" onclick="this.classList.toggle('expanded'); event.stopPropagation();">${task.note}</span>
                    </div>` : ''}
                </div>
                ${timeBtn}
                <div class="task-actions">
                    <button class="kebab-btn" onclick="openMenu(event, '${task.id}')"></button>
                </div>
                `;
                ul.appendChild(li);
            });

            container.appendChild(ul);

            // Validate stats after render
            updateProgress();
        }

        function renderStreak() {
            document.getElementById('streak-display').textContent = `${appData.stats.currentStreak} Days`;
            document.getElementById('stat-current-streak').textContent = appData.stats.currentStreak;
            document.getElementById('stat-best-streak').textContent = appData.stats.bestStreak;
        }


        // --- NAVIGATION ---
        function switchView(viewName) {
            // Skip auth check for public views (calendar and overview)
            // Skip auth check for public views
            if (viewName === 'calendar' || viewName === 'overview' || viewName === 'care-hub' || viewName === 'today') {
                // Public/Local views - no auth required or local mode allowed
                // Public views - no auth required, skip to rendering
            } else {
                // GATEKEEPER: STRICT AUTH CHECK for protected views
                if (!currentUser && viewName !== 'auth') {
                    console.warn("Unauthorized view access blocked:", viewName);
                    return;
                }
            }

            // Nav Styling
            document.querySelectorAll('.view-section').forEach(v => {
                v.style.display = 'none';
                v.classList.remove('active');
            });
            // Mobile nav is separate (bottom bar)
            document.querySelectorAll('.nav-item').forEach(link => link.classList.remove('active'));
            document.querySelectorAll('.mobile-nav-tab').forEach(tab => tab.classList.remove('active'));

            // Show Target
            const targetView = document.getElementById(`view-${viewName}`);
            if (targetView) {
                targetView.style.display = 'block';
                // Trigger reflow/animation?
                targetView.classList.add('active');
            }

            // Update Active Link (Desktop)
            const activeLink = document.querySelector(`.nav-item[data-view="${viewName}"]`);
            if (activeLink) activeLink.classList.add('active');

            // Update mobile nav tab
            const activeMobileTab = document.querySelector(`.mobile-nav-tab[data-view="${viewName}"]`);
            if (activeMobileTab) activeMobileTab.classList.add('active');

            // Close mobile sidebar
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            if (sidebar) sidebar.classList.remove('open');
            if (overlay) overlay.classList.remove('show');

            // Hide/show today-only elements based on view
            const todayOnlyElements = document.querySelectorAll('.today-only');
            todayOnlyElements.forEach(el => {
                el.style.display = viewName === 'today' ? '' : 'none';
            });

            // Render calendar when switching to calendar view
            if (viewName === 'calendar') {
                renderCalendar(currentCalendarYear, currentCalendarMonth);
            }
            if (viewName === 'overview') updateOverview();
            if (viewName === 'care-hub') renderCareHub();
        }

        // --- CARE HUB LOGIC ---
        // --- MEDS TRACKER LOGIC (Bound to Window for Safety) ---
        window.initMeds = function () {
            if (!appData.meds) {
                appData.meds = [];
            }
        }

        window.openAddMedModal = function () {
            // console.log("Opening Add Med Modal");
            const modal = document.getElementById('add-med-modal');
            if (modal) {
                modal.classList.add('show');
                modal.style.display = 'flex';
            }
        }

        window.closeAddMedModal = function () {
            document.getElementById('add-med-modal').classList.remove('show');
            document.getElementById('add-med-modal').style.display = 'none';
            // Reset form
            document.getElementById('med-name').value = '';
            document.getElementById('med-dosage-amount').value = '';
            document.getElementById('med-dosage-unit').value = 'mg';
            document.getElementById('med-frequency').value = '1';
            document.getElementById('med-inventory').value = '';
            document.getElementById('med-alert').value = '5';
            document.getElementById('med-instructions').value = '';

            // Reset Reminders
            document.getElementById('med-reminders-data').value = '';
            document.getElementById('med-reminders-display').innerText = 'No times set';

            // Reset Edit Mode
            document.getElementById('add-med-modal').removeAttribute('data-editing-id');
            document.querySelector('#add-med-modal .modal-title').innerText = 'Add Medication';
            document.querySelector('#add-med-modal .btn-modal-primary').innerText = 'Save Medication';
        }

        window.openEditMed = function () {
            // Get ID from Details View (which is currently open)
            const medName = document.getElementById('detail-med-name').innerText;
            const med = appData.meds.find(m => m.name === medName);
            // Note: best to store ID on the details modal itself to be safe, but name is unique enough for now? 
            // Actually, let's attach ID to the details modal when opening.

            const detailModal = document.getElementById('med-details-modal');
            const medId = detailModal.getAttribute('data-med-id');
            const medToEdit = appData.meds.find(m => m.id === medId);

            if (!medToEdit) return;

            closeMedDetailsModal();
            openAddMedModal();

            // Populate Form
            document.getElementById('med-name').value = medToEdit.name;

            // Split dosage
            // format: "amount unit" e.g "10 mg"
            const parts = medToEdit.dosage.split(' ');
            if (parts.length >= 2) {
                document.getElementById('med-dosage-amount').value = parts[0];
                document.getElementById('med-dosage-unit').value = parts[1];
            }

            document.getElementById('med-frequency').value = medToEdit.frequency;
            document.getElementById('med-inventory').value = medToEdit.inventory;
            document.getElementById('med-alert').value = medToEdit.limit;
            document.getElementById('med-instructions').value = medToEdit.instructions || '';

            // Populate Reminders
            if (medToEdit.reminderTimes && medToEdit.reminderTimes.length > 0) {
                document.getElementById('med-reminders-data').value = JSON.stringify(medToEdit.reminderTimes);
                document.getElementById('med-reminders-display').innerText = ' ' + medToEdit.reminderTimes.join(', ');
            } else {
                document.getElementById('med-reminders-data').value = '';
                document.getElementById('med-reminders-display').innerText = 'No times set';
            }

            // Set Edit Mode on Modal
            const addModal = document.getElementById('add-med-modal');
            addModal.setAttribute('data-editing-id', medToEdit.id);
            addModal.querySelector('.modal-title').innerText = 'Edit Medication';
            addModal.querySelector('.btn-modal-primary').innerText = 'Update Medication';

            // Trigger unit update to set correct steps
            updateDosageInput();
        }

        // saveMed and modal logic moved to src/ui/modals/medicationModal.js

        window.closeMedDetailsModal = function () {
            document.getElementById('med-details-modal').classList.remove('show');
            document.getElementById('med-details-modal').style.display = 'none';
        }

        window.deleteMed = function (id) {
            if (!confirm("Are you sure you want to delete this medication? This cannot be undone.")) return;
            appData.meds = appData.meds.filter(m => m.id !== id);
            saveData();
            closeMedDetailsModal();
            renderCareHub();
        }

        function updateOverview() {
            // Updated to be "Dashboard" logic
            if (!appData || !Array.isArray(appData.tasks)) return;

            // 1. Calculate Tasks
            // 1. Calculate Tasks (Usage getTodayTasks for correct day filtering)
            const tasksOnly = getTodayTasks().filter(t => (!t.type || t.type === 'task') && !t.dosage);
            const total = tasksOnly.length;
            const completed = tasksOnly.filter(t => t.checked).length;
            const todo = total - completed;
            const percent = total === 0 ? 0 : Math.round((completed / total) * 100);

            // Update Header Stats
            // Update Header Stats
            const fillEl = document.getElementById('progress-fill');
            const textEl = document.getElementById('progress-text');
            if (fillEl) fillEl.style.width = `${percent}%`;
            if (textEl) textEl.innerText = `${percent}%`;

            document.getElementById('d-total').innerText = total;
            document.getElementById('d-done').innerText = completed;
            document.getElementById('d-todo').innerText = todo;

            // Render Streak & Completion Logic (Merged)
            if (typeof renderStreak === 'function') renderStreak();

            // Calculate Completion Rate (Stats Grid)
            if (appData.history) {
                const historyKeys = Object.keys(appData.history);
                if (historyKeys.length > 0) {
                    let sum = 0;
                    historyKeys.forEach(k => sum += appData.history[k].pct);
                    const avg = Math.round(sum / historyKeys.length);
                    const completedRateEl = document.getElementById('stat-completion-rate');
                    if (completedRateEl) completedRateEl.textContent = `${avg}%`;
                } else {
                    const completedRateEl = document.getElementById('stat-completion-rate');
                    if (completedRateEl) completedRateEl.textContent = "0%";
                }
            }

            // 2. Render Meds Progress (Dots)
            const medsList = document.getElementById('progress-meds-list');
            if (medsList && appData.meds) {
                medsList.innerHTML = '';

                if (appData.meds.length === 0) {
                    medsList.innerHTML = '<span style="color:rgba(255,255,255,0.7); font-size:0.9rem;">No active medications</span>';
                } else {
                    appData.meds.forEach(med => {
                        // Create mini action card
                        const card = document.createElement('div');
                        card.className = 'med-action-card'; // Reuse existing class
                        card.style.background = 'rgba(255,255,255,0.1)';
                        card.style.border = '1px solid rgba(255,255,255,0.2)';
                        card.style.marginBottom = '8px';

                        // Check status
                        const todayStr = new Date().toDateString();
                        const history = med.history || [];
                        const takenTodayCount = history.filter(h => new Date(h.timestamp).toDateString() === todayStr).length;
                        const freq = med.frequency || 1;
                        const isDone = takenTodayCount >= freq;
                        const btnText = isDone ? `Done (${takenTodayCount}/${freq})` : `Take (${takenTodayCount}/${freq})`;

                        card.innerHTML = `
                            <div class="med-info" style="color:white !important;">
                                <div class="med-name" style="color:white;">${med.name}</div>
                                <div class="med-dosage" style="color:rgba(255,255,255,0.7);">${med.dosage}</div>
                            </div>
                            <div class="med-action">
                                 ${isDone
                                ? `<button class="btn-take btn-taken" style="padding:4px 8px; font-size:0.8rem;" disabled></button>`
                                : `<button class="btn-take" style="padding:4px 12px; font-size:0.85rem;" onclick="takeMed('${med.id}')">Take</button>`
                            }
                            </div>
                        `;
                        medsList.appendChild(card);
                    });
                }
            }

            // 3. Time
            if (typeof updateTimeStats === 'function') updateTimeStats();
        }

        window.openMedDetails = function (medId) {
            const med = appData.meds.find(m => m.id === medId);
            if (!med) return;

            // Store ID for Edit Action
            document.getElementById('med-details-modal').setAttribute('data-med-id', medId);

            document.getElementById('detail-med-name').innerText = med.name;
            document.getElementById('detail-med-dosage').innerText = `${med.dosage} (${med.frequency}x Daily)`;
            document.getElementById('detail-med-inventory').innerText = `${med.inventory} Units Left (Alert at ${med.limit})`;
            document.getElementById('detail-med-instructions').innerText = med.instructions || 'No instructions provided.';

            // Reminders Population
            const remindersContainer = document.getElementById('detail-med-reminders-row');
            if (remindersContainer) {
                remindersContainer.innerHTML = '';
                // Handle different implementations (camelCase vs snake_case)
                const times = med.reminderTimes || med.reminder_times || [];

                if (times && times.length > 0) {
                    times.forEach(time => {
                        const chip = document.createElement('span');
                        chip.innerText = time;
                        chip.style.background = '#F3F4F6';
                        chip.style.padding = '4px 8px';
                        chip.style.borderRadius = '6px';
                        chip.style.fontSize = '0.85rem';
                        chip.style.color = '#374151';
                        remindersContainer.appendChild(chip);
                    });
                } else {
                    remindersContainer.innerText = 'No specific times set';
                    remindersContainer.style.color = '#9CA3AF';
                    remindersContainer.style.fontSize = '0.9rem';
                }
            }

            // Delete Action
            const deleteBtn = document.getElementById('detail-med-delete');
            deleteBtn.onclick = function () {
                openDeleteConfirmModal(med);
            };

            // Edit Action
            const editBtn = document.getElementById('detail-med-edit');
            if (editBtn) editBtn.onclick = function () {
                if (window.openEditMed) window.openEditMed(med.id);
            };

            const modal = document.getElementById('med-details-modal');
            modal.classList.add('show');
            modal.style.display = 'flex';
        }

        window.saveMed = function () {
            const name = document.getElementById('med-name').value;

            // Combine Dosage Fields
            const amount = document.getElementById('med-dosage-amount').value;
            const unit = document.getElementById('med-dosage-unit').value;
            const dosage = amount ? `${amount} ${unit}` : '';

            const frequency = parseInt(document.getElementById('med-frequency').value) || 1;
            const inventory = parseInt(document.getElementById('med-inventory').value) || 0;
            const alertAt = parseInt(document.getElementById('med-alert').value) || 5;
            const instructions = document.getElementById('med-instructions').value;

            // Reminders
            const remindersData = document.getElementById('med-reminders-data').value;
            const reminderTimes = remindersData ? JSON.parse(remindersData) : [];

            if (!name) {
                alert("Please enter a medication name.");
                return;
            }

            // Check for Edit Mode
            const editingId = document.getElementById('add-med-modal').getAttribute('data-editing-id');

            if (editingId) {
                // UPDATE Existing (Optimistic UI handled here, Service for DB)
                const index = appData.meds.findIndex(m => m.id === editingId);
                if (index !== -1) {
                    // Update Local State
                    appData.meds[index] = {
                        ...appData.meds[index],
                        name, dosage, frequency, inventory, limit: alertAt, instructions, reminderTimes
                    };

                    // Update DB via Service
                    if (window.services && window.services.medication) {
                        window.services.medication.saveMedication(appData.meds[index], currentUser?.id)
                            .then(() => console.log("Med updated remotely"))
                            .catch(err => console.error("Med update failed", err));
                    }
                }
            } else {
                // CREATE New
                const newMed = {
                    id: 'med_' + Date.now(),
                    name, dosage, frequency, inventory, limit: alertAt, instructions, reminderTimes,
                    history: [], stats: { takenCount: 0, skippedCount: 0 }
                };

                appData.meds.push(newMed);

                // Save DB via Service
                if (window.services && window.services.medication) {
                    window.services.medication.saveMedication(newMed, currentUser?.id)
                        .then(() => console.log("Med saved remotely"))
                        .catch(err => console.error("Med save failed", err));
                }
            }

            saveData(); // Local Storage Backup
            closeAddMedModal();
            renderMeds();
        }

        window.updateDosageInput = function () {
            const unit = document.getElementById('med-dosage-unit').value;
            const amountInput = document.getElementById('med-dosage-amount');

            if (['pills', 'puffs', 'drops'].includes(unit)) {
                amountInput.step = "1";
                amountInput.placeholder = "0";
            } else {
                // mg, ml
                amountInput.step = "0.1";
                amountInput.placeholder = "0.0";
            }
        }

        function renderMeds() {
            const container = document.getElementById('active-meds-grid');
            const section = document.getElementById('active-meds-container');

            if (!appData.meds || appData.meds.length === 0) {
                if (section) section.style.display = 'none';
                return;
            }

            if (section) section.style.display = 'block';
            container.innerHTML = '';

            const todayStr = new Date().toDateString();

            appData.meds.forEach(med => {
                const card = document.createElement('div');
                card.className = 'med-action-card';

                // Check inventory status
                const isLow = med.inventory <= med.limit;
                const badgeClass = isLow ? 'inventory-low' : 'inventory-ok';
                const badgeText = `${med.inventory} Left`;

                // Check taken status (Multi-dose logic)
                const freq = med.frequency || 1;
                const history = med.history || [];
                const takenTodayCount = history.filter(h => {
                    return new Date(h.timestamp).toDateString() === todayStr;
                }).length;

                const isDone = takenTodayCount >= freq;

                // Button Text
                const btnText = isDone ? `Done (${takenTodayCount}/${freq})` : `Take (${takenTodayCount}/${freq})`;

                card.innerHTML = `
                    <div class="med-info" onclick="openMedDetails('${med.id}')" style="cursor: pointer;">
                        <div class="med-name">${med.name}</div>
                        <div class="med-dosage">${med.dosage}</div>
                        <div class="inventory-badge ${badgeClass}">${badgeText}</div>
                    </div>
                    <div class="med-action">
                        ${isDone
                        ? `<button class="btn-take btn-taken" disabled>${btnText}</button>
                               <span class="undo-link" onclick="undoTakeMed('${med.id}')">Undo</span>`
                        : `<button class="btn-take" onclick="takeMed('${med.id}')">${btnText}</button>`
                    }
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function takeMed(id) {
            const medIndex = appData.meds.findIndex(m => m.id === id);
            if (medIndex !== -1) {
                // Optimistic UI Update
                const med = appData.meds[medIndex];

                // Call Service
                if (window.services && window.services.medication) {
                    window.services.medication.takeMedication(med, currentUser?.id)
                        .then(updatedMed => {
                            // Update local state with server response (which has new history/inventory)
                            appData.meds[medIndex] = updatedMed;
                            renderMeds();
                            saveData();
                        })
                        .catch(err => {
                            console.error("Take med failed", err);
                            // Revert on failure? For now just log.
                        });
                } else {
                    // Fallback for local
                    med.inventory--;
                    med.history.push({ timestamp: Date.now(), action: 'taken' });
                    saveData();
                    // renderMeds moved to src/ui/pages/careHub.js
                }
            }
        }

        function undoTakeMed(id) {
            const med = appData.meds.find(m => m.id === id);
            if (med) {
                med.inventory++;
                med.history.pop(); // Remove last entry
                saveData();
                renderCareHub(); // Update UI
            }
        }

        function renderCareHub() {
            const container = document.getElementById('care-hub-content');
            if (!container) return;

            // Render Active Meds Grid
            renderMeds();

            // Clear to be safe if re-rendering dynamic updates
            container.innerHTML = '';

            // SPECIFIC 6 CARDS for Care Hub Redesign (Grid)
            const careHubData = [
                {
                    icon: "",
                    title: "Meds Tracker",
                    desc: "Risperidone, Ritalin logs.",
                    color: "#dc3545", // Red
                    config: { customAction: "openAddMedModal()" }
                },
                {
                    icon: "",
                    title: "Sleep Quality",
                    desc: "Track duration & wakings.",
                    color: "#6610f2", // Indigo
                    config: { template: "sleep", metrics: ["Duration", "Wakings", "Quality"] }
                },
                {
                    icon: "",
                    title: "Camel Milk",
                    desc: "Track ml & reaction.",
                    color: "#fd7e14", // Orange
                    config: { template: "nutrition", item: "Camel Milk", unit: "ml" }
                },
                {
                    icon: "",
                    title: "Daily Report",
                    desc: "Share status with Teacher/Nanny.",
                    color: "#0d6efd", // Blue
                    config: { template: "report", recipient: "Teacher/Nanny" }
                },
                {
                    icon: "",
                    title: "Sensory Reset",
                    desc: "Lifting & calming tasks.",
                    color: "#198754", // Green
                    config: { template: "sensory", type: "Heavy Work" }
                },
                {
                    icon: "",
                    title: "Potty Training",
                    desc: "Track accidents & success.",
                    color: "#0dcaf0", // Teal
                    config: { template: "potty", tracks: ["Success", "Accident"] }
                }
            ];

            // Create Grid Container
            const grid = document.createElement('div');
            grid.className = 'care-hub-grid';

            careHubData.forEach(item => {
                const card = document.createElement('div');
                card.className = 'grid-card';
                // Top border color line
                card.style.borderTop = `4px solid ${item.color}`;

                // Determine onClick Action
                const onClickAction = (item.config && item.config.customAction)
                    ? item.config.customAction
                    : `openTaskModal(null, '${item.title}')`;

                card.innerHTML = `
                    <div>
                        <div style="background: ${item.color}15; color: ${item.color};" class="grid-card-icon">${item.icon}</div>
                        <div class="grid-card-title">${item.title}</div>
                        <div class="grid-card-desc">${item.desc}</div>
                    </div>
                    <button class="card-btn" style="color:${item.color}; background:${item.color}10;" onclick="${onClickAction}">
                        Use Template
                    </button>
                `;
                grid.appendChild(card);
            });

            container.appendChild(grid);
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('overlay');
            sb.classList.toggle('open');
            ov.classList.toggle('show');
        }

        // Duplicate updateOverview removed. Logic merged into main function at line ~6164.

        // --- TIME LOGIC ---
        function updateClock() {
            const now = new Date();
            let hrs = now.getHours();
            const mins = now.getMinutes().toString().padStart(2, '0');
            const ampm = hrs >= 12 ? 'PM' : 'AM';
            hrs = hrs % 12 || 12;

            const timeStr = `${hrs}:${mins} `;

            // Safety check for elements
            const elTime = document.getElementById('clock-time');
            const elAmPm = document.getElementById('clock-ampm');
            if (elTime) elTime.textContent = timeStr;
            if (elAmPm) elAmPm.textContent = ampm;
        }

        function openViewTaskModal(id) {
            const task = appData.tasks.find(t => t.id === id);
            if (!task) return;

            document.getElementById('vt-id').value = id;
            document.getElementById('vt-title').textContent = task.title || task.text;

            // Date Display
            const dateDisplay = document.getElementById('vt-date');
            if (task.date) {
                const [y, m, d] = task.date.split('-');
                const dateObj = new Date(y, m - 1, d);
                dateDisplay.textContent = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
            } else if (task.recur) {
                dateDisplay.textContent = "Recurring: " + (task.recurDays ? task.recurDays.join(', ') : 'Daily');
            }

            // Time
            const timeDisplay = document.getElementById('vt-time');
            if (task.startTime && task.endTime) {
                timeDisplay.textContent = `${task.startTime} - ${task.endTime}`;
            } else {
                timeDisplay.textContent = "All Day";
            }

            // Location
            const locRow = document.getElementById('vt-loc-row');
            if (task.location) {
                document.getElementById('vt-location').textContent = task.location;
                locRow.style.display = 'flex';
            } else {
                locRow.style.display = 'none';
            }

            // Note
            const descRow = document.getElementById('vt-desc-row');
            if (task.note) {
                document.getElementById('vt-desc').textContent = task.note;
                descRow.style.display = 'flex';
            } else {
                descRow.style.display = 'none';
            }

            const modal = document.getElementById('view-task-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        function closeViewTaskModal() {
            const modal = document.getElementById('view-task-modal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        function editCurrentViewTask() {
            const id = document.getElementById('vt-id').value;
            closeViewTaskModal();
            closeDayPopup(); // Close the day list too so we don't have layers
            // We need to know if it was an Event or Task to open correctly? 
            // openTaskModal handles logic by ID lookup.
            openTaskModal(id);
        }



        // Close when clicking outside of modals
        window.onclick = function (event) {
            const addModal = document.getElementById('add-med-modal');
            const detailsModal = document.getElementById('med-details-modal');
            const remindersModal = document.getElementById('reminders-modal');
            if (event.target == addModal) {
                closeAddMedModal();
            }
            if (event.target == detailsModal) {
                closeMedDetailsModal();
            }
            if (event.target == remindersModal) {
                closeRemindersModal();
            }
        }

        // Reminders Modal Logic
        window.openRemindersModal = function () {
            const freq = parseInt(document.getElementById('med-frequency').value) || 1;
            const container = document.getElementById('reminders-list');
            const countSpan = document.getElementById('reminders-count');

            container.innerHTML = '';
            countSpan.innerText = freq;

            // Get existing values if any
            const existingData = document.getElementById('med-reminders-data').value;
            const existingTimes = existingData ? JSON.parse(existingData) : [];

            for (let i = 0; i < freq; i++) {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.alignItems = 'center';
                row.style.justifyContent = 'space-between';

                const label = document.createElement('label');
                label.innerText = `Dose ${i + 1}`;
                label.style.fontWeight = '500';
                label.style.color = 'var(--text-secondary)';

                const input = document.createElement('input');
                input.type = 'time';
                input.className = 'form-input reminder-time-input';
                input.style.width = '140px';
                if (existingTimes[i]) {
                    input.value = existingTimes[i];
                }

                row.appendChild(label);
                row.appendChild(input);
                container.appendChild(row);
            }

            const modal = document.getElementById('reminders-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        }

        window.closeRemindersModal = function () {
            const modal = document.getElementById('reminders-modal');
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        window.saveReminders = function () {
            const inputs = document.querySelectorAll('.reminder-time-input');
            const times = [];
            inputs.forEach(input => {
                if (input.value) times.push(input.value);
            });

            // Update hidden input
            document.getElementById('med-reminders-data').value = JSON.stringify(times);

            // Update display
            const display = document.getElementById('med-reminders-display');
            if (times.length > 0) {
                display.innerText = ' ' + times.join(', ');
            } else {
                display.innerText = 'No times set';
            }

            closeRemindersModal();
        }

        // Boot handled by src/app.js


    </script>
    <!-- Add Med Modal -->
    <div id="add-med-modal" class="modal-overlay">
        <div class="modal-card" style="position: relative;">
            <button class="close-modal-btn" onclick="closeAddMedModal()"
                style="position: absolute; top: 16px; right: 16px; font-size: 1.2rem; background: none; border: none; cursor: pointer; color: #4B5563; z-index: 10;">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="modal-title">Add Medication</h2>

            <div class="form-group">
                <label class="form-label">Medication Name</label>
                <input type="text" id="med-name" class="form-input" placeholder="e.g., Risperidone">
            </div>

            <!-- Row 1: Unit -->
            <div class="form-group">
                <label class="form-label">Unit Type</label>
                <select id="med-dosage-unit" class="form-input" onchange="updateDosageInput()">
                    <option value="mg"> mg (Milligrams)</option>
                    <option value="ml"> ml (Milliliters)</option>
                    <option value="pills"> Tablet(s) / Pill(s)</option>
                    <option value="puffs"> Puff(s)</option>
                    <option value="drops"> Drop(s)</option>
                </select>
            </div>

            <!-- Row 2: Amount + Frequency -->
            <div style="display: flex; gap: 16px;">
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">Amount</label>
                    <input type="number" id="med-dosage-amount" class="form-input" placeholder="0.0" step="0.1" min="0">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">Times/Day</label>
                    <input type="number" id="med-frequency" class="form-input" value="1" min="1">
                </div>
            </div>

            <!-- Reminders Section -->
            <div class="form-group" style="margin-top: 8px;">
                <label class="form-label">Reminders</label>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button class="btn-secondary" onclick="openRemindersModal()"
                        style="padding: 8px 16px; font-size: 0.9rem;">
                        <i class="fas fa-clock" style="margin-right: 6px;"></i> Set Times
                    </button>
                    <div id="med-reminders-display" style="color: var(--text-secondary); font-size: 0.9rem;">
                        No times set
                    </div>
                    <input type="hidden" id="med-reminders-data">
                </div>
            </div>

            <!-- Row 3: Inventory + Alert -->
            <div style="display: flex; gap: 16px;">
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">Current Count</label>
                    <input type="number" id="med-inventory" class="form-input" placeholder="28">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">Low Alert At</label>
                    <input type="number" id="med-alert" class="form-input" value="5" min="0">
                </div>
            </div>

            <!-- Neuro-Behavioral Tracking Section -->
            <div class="form-group"
                style="background: rgba(243, 244, 246, 0.5); padding: 12px; border-radius: 8px; margin-top: 4px;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                        <label class="form-label" style="display:block; margin-bottom:4px;">Enable Neuro-Behavioral
                            Tracking</label>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); line-height: 1.3;">
                            Turn on for meds that affect mood, sleep, or appetite<br>(e.g., Ritalin, Risperidone).
                        </div>
                    </div>
                    <label class="switch"
                        style="position: relative; display: inline-block; width: 44px; height: 24px; margin-left: 12px; flex-shrink: 0;">
                        <input type="checkbox" id="neuro-tracking-toggle" onchange="toggleNeuroOptions()">
                        <span class="slider round"
                            style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px;"></span>
                    </label>
                    <style>
                        .switch input {
                            opacity: 0;
                            width: 0;
                            height: 0;
                        }

                        .switch input:checked+.slider {
                            background-color: var(--primary);
                        }

                        .switch input:focus+.slider {
                            box-shadow: 0 0 1px var(--primary);
                        }

                        .switch input:checked+.slider:before {
                            transform: translateX(20px);
                        }

                        .slider:before {
                            position: absolute;
                            content: "";
                            height: 18px;
                            width: 18px;
                            left: 3px;
                            bottom: 3px;
                            background-color: white;
                            transition: .4s;
                            border-radius: 50%;
                        }
                    </style>
                </div>

                <!-- Conditional Options -->
                <div id="neuro-options"
                    style="display: none; margin-top: 12px; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 12px;">
                    <label class="form-label" style="margin-bottom: 8px;">When taking this, ask me about:</label>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <label
                            style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: var(--text-dark); cursor: pointer;">
                            <input type="checkbox" id="neuro-appetite" style="width: 16px; height: 16px;">
                             Appetite Level
                        </label>
                        <label
                            style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: var(--text-dark); cursor: pointer;">
                            <input type="checkbox" id="neuro-drowsy" style="width: 16px; height: 16px;">
                             Drowsiness / Sedation
                        </label>
                        <label
                            style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: var(--text-dark); cursor: pointer;">
                            <input type="checkbox" id="neuro-irritability" style="width: 16px; height: 16px;">
                             Irritability / Aggression
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Instructions</label>
                <textarea id="med-instructions" class="form-input" rows="3"
                    placeholder="e.g., Take at night with water..."></textarea>
            </div>

            <div class="modal-buttons">
                <button class="btn-modal-secondary" onclick="closeAddMedModal()">Cancel</button>
                <button class="btn-modal-primary" onclick="saveMed()">Save Medication</button>
            </div>
        </div>
    </div>

    <!-- Med Details Modal -->
    <div id="med-details-modal" class="modal-overlay">
        <div class="modal-card" style="position: relative; padding-top: 20px;">
            <button class="close-modal-btn" onclick="closeMedDetailsModal()"
                style="position: absolute; top: 12px; right: 12px; font-size: 1.2rem; background: none; border: none; cursor: pointer; color: var(--text-secondary);">
                <i class="fas fa-times"></i>
            </button>

            <div class="modal-header" style="text-align: center; border-bottom: none; padding-bottom: 0;">
                <h3 id="detail-med-name" class="modal-title"
                    style="font-size: 1.8rem; color: var(--primary); font-weight: 700; margin-bottom: 8px;">
                    Medication Name</h3>
            </div>

            <div class="modal-body" style="margin-top: 16px;">
                <!-- Table-like Grid Layout -->
                <div style="border: 1px solid #e5e7eb; border-radius: 16px; overflow: hidden; margin-bottom: 24px;">

                    <!-- Row 1 -->
                    <div style="display: grid; grid-template-columns: 120px 1fr; border-bottom: 1px solid #e5e7eb;">
                        <div
                            style="padding: 16px; background-color: white; font-weight: 700; color: #111827; border-right: 1px solid #e5e7eb; display: flex; align-items: center;">
                            Dosage
                        </div>
                        <div id="detail-med-dosage"
                            style="padding: 16px; color: #4B5563; font-size: 0.95rem; background: white;">
                            --
                        </div>
                    </div>

                    <!-- Row 2: Inventory -->
                    <div style="display: grid; grid-template-columns: 120px 1fr; border-bottom: 1px solid #e5e7eb;">
                        <div
                            style="padding: 16px; background-color: white; font-weight: 700; color: #111827; border-right: 1px solid #e5e7eb; display: flex; align-items: center;">
                            Inventory
                        </div>
                        <div id="detail-med-inventory"
                            style="padding: 16px; color: #4B5563; font-size: 0.95rem; background: white;">
                            --
                        </div>
                    </div>

                    <!-- Row 2.5: Reminders -->
                    <div style="display: grid; grid-template-columns: 120px 1fr; border-bottom: 1px solid #e5e7eb;">
                        <div
                            style="padding: 16px; background-color: white; font-weight: 700; color: #111827; border-right: 1px solid #e5e7eb; display: flex; align-items: center;">
                            Reminders
                        </div>
                        <div id="detail-med-reminders-row"
                            style="padding: 16px; background: white; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; min-height: 53px;">
                            <!-- Injected by JS -->
                        </div>
                    </div>

                    <!-- Row 3 -->
                    <div style="display: grid; grid-template-columns: 120px 1fr;">
                        <div
                            style="padding: 16px; background-color: white; font-weight: 700; color: #111827; border-right: 1px solid #e5e7eb; display: flex; align-items: center;">
                            Instructions
                        </div>
                        <div id="detail-med-instructions"
                            style="padding: 16px; color: #4B5563; font-size: 0.95rem; line-height: 1.5; background: white;">
                            --
                        </div>
                    </div>
                </div>

                <!-- Action Buttons: Centered -->
                <div style="display: flex; gap: 24px; justify-content: center; align-items: center; margin-top: 32px;">
                    <!-- Delete Button: Red Text -->
                    <button id="detail-med-delete" class="btn-delete-custom">
                        Delete
                    </button>
                    <!-- Edit Button: Blue Pill -->
                    <button id="detail-med-edit"
                        style="background-color: var(--primary); color: white; border: none; padding: 12px 40px; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 12px rgba(40, 67, 147, 0.2);">
                        Edit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .btn-delete-custom {
            background: transparent;
            border: none;
            color: #ef4444;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .btn-delete-custom:hover {
            border-color: #ef4444;
            border-radius: 8px;
            /* Corner radius on hover */
            background-color: rgba(239, 68, 68, 0.05);
        }
    </style>
    <div id="reminders-modal" class="modal-overlay" style="z-index: 2000;">
        <div class="modal-card" style="max-width: 320px; position: relative;">
            <button class="close-modal-btn" onclick="closeRemindersModal()"
                style="position: absolute; top: 16px; right: 16px; font-size: 1.2rem; background: none; border: none; cursor: pointer; color: #4B5563; z-index: 10;">
                <i class="fas fa-times"></i>
            </button>
            <h3 class="modal-title">Set Reminder Times</h3>
            <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 0.9rem;">
                Set a time for each of your <span id="reminders-count">1</span> daily doses.
            </p>

            <div id="reminders-list"
                style="display: flex; flex-direction: column; gap: 12px; max-height: 300px; overflow-y: auto;">
                <!-- Dynamic Time Inputs will go here -->
            </div>

            <div class="modal-buttons" style="margin-top: 24px;">
                <button class="btn-modal-secondary" onclick="closeRemindersModal()">Cancel</button>
                <button class="btn-modal-primary" onclick="saveReminders()">Save Times</button>
            </div>
        </div>
    </div>
    <!-- Day Action Popup (Missing previously) -->
    <div id="day-action-popup" class="modal-overlay" style="z-index: 2000;">
        <div class="modal-card" style="max-width: 400px; position: relative;">
            <button class="close-modal-btn" onclick="closeDayActionPopup()"
                style="position: absolute; top: 16px; right: 16px; font-size: 1.2rem; background: none; border: none; cursor: pointer; color: #4B5563; z-index: 10;">
                <i class="fas fa-times"></i>
            </button>

            <h3 id="day-action-date" class="modal-title">Selected Date</h3>

            <div id="day-action-list" style="margin-bottom: 20px; max-height: 250px; overflow-y: auto;">
                <!-- Tasks injected here -->
            </div>

            <div class="modal-buttons">
                <button class="btn-modal-primary" onclick="openTaskModalFromChoice('task')">+ Add Task</button>
                <button class="btn-modal-secondary" onclick="openTaskModalFromChoice('event')">+ Add Event</button>
            </div>
        </div>
    </div>
    <script>
        // Force Global Coming Soon (Fallback)
        window.showComingSoon = function (title) {
            console.log("Showing Coming Soon Modal for:", title);

            // Overlay
            const overlay = document.createElement('div');
            overlay.id = 'coming-soon-overlay';
            overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:99999; display:flex; align-items:center; justify-content:center; backdrop-filter: blur(2px);';

            // Card
            const card = document.createElement('div');
            card.style.cssText = 'background:white; padding:32px; border-radius:16px; text-align:center; max-width:90%; width:340px; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); position:relative; z-index:100000;';

            card.innerHTML = `
            <div style="font-size: 3.5rem; margin-bottom: 20px;"></div>
            <h3 style="margin: 0 0 12px; font-size: 1.5rem; color: #1e293b; font-weight:700;">Coming Soon</h3>
            <p style="color: #64748b; font-size: 1.05rem; margin-bottom:28px; line-height:1.6;">
                The <strong>${title}</strong> feature is currently being built.<br>Check back later!
            </p>
            <button id="cs-close-btn" style="background: #2563eb; color: white; border: none; padding: 12px 30px; border-radius: 10px; font-weight: 600; cursor: pointer; font-size:1rem; width:100%; transition: background 0.2s;">
                Got it
            </button>
        `;

            // Handlers
            const close = () => {
                overlay.remove();
            };

            overlay.onclick = (e) => { if (e.target === overlay) close(); };
            const btn = card.querySelector('#cs-close-btn');
            btn.onclick = close;

            // Hover effect for button
            btn.onmouseover = () => btn.style.background = '#1d4ed8';
            btn.onmouseout = () => btn.style.background = '#2563eb';

            overlay.appendChild(card);
            document.body.appendChild(overlay);
        };
    </script>
</body>

</html>